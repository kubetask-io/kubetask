---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.5
  name: workflows.kubetask.io
spec:
  group: kubetask.io
  names:
    kind: Workflow
    listKind: WorkflowList
    plural: workflows
    shortNames:
    - wf
    singular: workflow
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: "Workflow represents a reusable workflow template for multi-stage
          task orchestration.\nWorkflow is a pure template definition - it does not
          execute by itself.\nTo execute a workflow, create a WorkflowRun that references
          this Workflow.\n\nWorkflow defines a sequence of stages, where each stage
          contains one or more\nTasks that run in parallel. Stages execute sequentially
          - stage N+1 starts\nonly after all tasks in stage N complete successfully.\n\nExample:\n\n\tworkflow
          = [[task] -> [task, task, task] -> [task]]\n\nThis creates 3 stages where:\n
          \ - Stage 0: runs 1 task\n  - Stage 1: runs 3 tasks in parallel (starts
          after stage 0 completes)\n  - Stage 2: runs 1 task (starts after all stage
          1 tasks complete)\n\nUsage:\n\n\tapiVersion: kubetask.io/v1alpha1\n\tkind:
          Workflow\n\tmetadata:\n\t  name: ci-pipeline\n\tspec:\n\t  stages:\n\t    -
          tasks:\n\t        - name: lint\n\t          spec:\n\t            description:
          \"Run linting\"\n\t---\n\tapiVersion: kubetask.io/v1alpha1\n\tkind: WorkflowRun\n\tmetadata:\n\t
          \ name: ci-pipeline-run-001\n\tspec:\n\t  workflowRef: ci-pipeline"
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: Spec defines the workflow template configuration
            properties:
              stages:
                description: |-
                  Stages defines the sequential stages of the workflow.
                  Each stage contains one or more tasks that run in parallel.
                  Stages are executed sequentially - stage N+1 starts only after
                  all tasks in stage N complete successfully.
                items:
                  description: WorkflowStage defines a stage in the workflow containing
                    parallel tasks.
                  properties:
                    name:
                      description: |-
                        Name is an optional name for this stage.
                        If not specified, auto-generated as "stage-0", "stage-1", etc.
                        based on the stage's index in the stages array.
                      type: string
                    tasks:
                      description: |-
                        Tasks defines the tasks to run in parallel within this stage.
                        All tasks in a stage start simultaneously and must all complete
                        successfully before the next stage begins.
                      items:
                        description: |-
                          WorkflowTask defines a task within a workflow stage.
                          Each task will be created as a Task CR when its stage starts.
                        properties:
                          name:
                            description: |-
                              Name is a required unique name for this task within the workflow.
                              The actual Task CR name will be "{workflow-name}-{task-name}".
                              Must be a valid Kubernetes name (lowercase, alphanumeric, hyphens).
                            maxLength: 53
                            minLength: 1
                            pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                            type: string
                          spec:
                            description: |-
                              Spec is the TaskSpec that will be used to create the Task.
                              Each task should specify its own agentRef as needed.
                            properties:
                              agentRef:
                                description: |-
                                  AgentRef references an Agent for this task.
                                  If not specified, uses the "default" Agent in the same namespace.
                                type: string
                              contexts:
                                description: |-
                                  Contexts provides additional context for the task.
                                  Contexts are processed in array order, with later contexts taking precedence.

                                  Context priority (lowest to highest):
                                    1. Agent.contexts (Agent-level defaults)
                                    2. Task.contexts (Task-specific contexts)
                                    3. Task.description (highest, becomes ${WORKSPACE_DIR}/task.md)

                                  Example:
                                    contexts:
                                      - type: Text
                                        text: "Always use conventional commits"
                                      - type: Git
                                        mountPath: src
                                        git:
                                          repository: https://github.com/org/repo
                                          ref: main
                                items:
                                  description: |-
                                    ContextItem defines context with content and mount path.
                                    Used directly in Task/Agent specs to provide additional context for task execution.
                                  properties:
                                    configMap:
                                      description: ConfigMap context (required when
                                        Type == "ConfigMap")
                                      properties:
                                        key:
                                          description: |-
                                            Key specifies a single key to mount as a file.
                                            If not specified, all keys are mounted as files in the directory.
                                          type: string
                                        name:
                                          description: Name of the ConfigMap
                                          type: string
                                        optional:
                                          description: Optional specifies whether
                                            the ConfigMap must exist.
                                          type: boolean
                                      required:
                                      - name
                                      type: object
                                    fileMode:
                                      description: |-
                                        FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                                        Only applicable when MountPath is specified.
                                        If not specified, defaults to 0644.
                                      format: int32
                                      type: integer
                                    git:
                                      description: Git context (required when Type
                                        == "Git")
                                      properties:
                                        depth:
                                          default: 1
                                          description: |-
                                            Depth specifies the clone depth for shallow cloning.
                                            1 means shallow clone (fastest), 0 means full clone.
                                            Defaults to 1 for efficiency.
                                          type: integer
                                        path:
                                          description: |-
                                            Path is the path within the repository to mount.
                                            Can be a file or directory. If empty, the entire repository is mounted.

                                            Note on .git directory:
                                              - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                              - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                            Example: ".claude/", "docs/guide.md"
                                          type: string
                                        ref:
                                          default: HEAD
                                          description: |-
                                            Ref is the Git reference (branch, tag, or commit SHA).
                                            Defaults to "HEAD" if not specified.
                                          type: string
                                        repository:
                                          description: |-
                                            Repository is the Git repository URL.
                                            Example: "https://github.com/org/contexts"
                                          type: string
                                        secretRef:
                                          description: |-
                                            SecretRef references a Secret containing Git credentials.
                                            The Secret should contain one of:
                                              - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                              - "ssh-privatekey": For SSH key-based auth
                                            If not specified, anonymous clone is attempted.
                                          properties:
                                            name:
                                              description: Name of the Secret containing
                                                Git credentials.
                                              type: string
                                          required:
                                          - name
                                          type: object
                                      required:
                                      - repository
                                      type: object
                                    mountPath:
                                      description: |-
                                        MountPath specifies where this context should be mounted in the agent pod.

                                        Path resolution follows Tekton conventions:
                                        - Absolute paths (starting with "/") are used as-is
                                        - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                                        See ContextRef.MountPath for detailed examples.

                                        Note: For Runtime context type, MountPath is ignored - content is always
                                        appended to task.md.
                                      type: string
                                    runtime:
                                      description: |-
                                        Runtime context (optional when Type == "Runtime")
                                        Enables KubeTask platform awareness. The controller injects a system prompt
                                        that explains the runtime environment to the agent.
                                      type: object
                                    text:
                                      description: |-
                                        Text is the text content (required when Type == "Text").
                                        Contains text content defined directly in YAML.
                                      type: string
                                    type:
                                      description: 'Type of context source: Text,
                                        ConfigMap, Git, or Runtime'
                                      enum:
                                      - Text
                                      - ConfigMap
                                      - Git
                                      - Runtime
                                      type: string
                                  required:
                                  - type
                                  type: object
                                type: array
                              description:
                                description: |-
                                  Description is the task instruction/prompt.
                                  The controller creates ${WORKSPACE_DIR}/task.md with this content
                                  (where WORKSPACE_DIR is configured in Agent.spec.workspaceDir, defaulting to "/workspace").
                                  This is the primary way to tell the agent what to do.

                                  Example:
                                    description: "Update all dependencies and create a PR"
                                type: string
                            type: object
                        required:
                        - name
                        - spec
                        type: object
                      minItems: 1
                      type: array
                  required:
                  - tasks
                  type: object
                minItems: 1
                type: array
            required:
            - stages
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources: {}
