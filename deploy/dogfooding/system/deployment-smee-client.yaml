# Copyright Contributors to the KubeOpenCode project
# Smee.io client for forwarding GitHub webhooks to the internal webhook server.
# This is needed because GitHub requires trusted SSL certificates, but OpenShift
# uses self-signed certificates by default.
#
# Prerequisites:
# 1. Create configmap-smee.yaml with your smee.io channel URL
# 2. Apply: kubectl apply -f configmap-smee.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: smee-client
  namespace: kubeopencode-system
  labels:
    app.kubernetes.io/name: smee-client
    app.kubernetes.io/component: webhook-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: smee-client
  template:
    metadata:
      labels:
        app.kubernetes.io/name: smee-client
        app.kubernetes.io/component: webhook-proxy
    spec:
      containers:
        - name: smee-client
          image: node:20-alpine
          command:
            - sh
            - -c
            - |
              npx smee-client --url "$SMEE_URL" --target "$TARGET_URL"
          env:
            # Set HOME to /tmp to avoid permission issues with OpenShift's random UID
            - name: HOME
              value: /tmp
            - name: npm_config_cache
              value: /tmp/.npm
          envFrom:
            - configMapRef:
                name: smee-config
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
