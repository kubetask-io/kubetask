# Copyright Contributors to the KubeOpenCode project
# Agent configuration for AI agent with credentials
apiVersion: kubeopencode.io/v1alpha1
kind: Agent
metadata:
  name: default
spec:
  agentImage: quay.io/kubeopencode/kubeopencode-agent-gemini:latest
  workspaceDir: /workspace
  command:
    - sh
    - -c
    - gemini --output-format stream-json --yolo -p "$(cat ${WORKSPACE_DIR}/task.md)" | stream-json-reader
  serviceAccountName: kubeopencode-agent
  maxConcurrentTasks: 3
  credentials:
    # Mount entire secret - all keys become env vars automatically
    - name: git
      secretRef:
        name: git-settings
    - name: gemini
      secretRef:
        name: gemini-credentials
    # GitHub App credentials for IAT generation (mounted as files)
    - name: github-app-client-id
      secretRef:
        name: github-app-credentials
        key: client_id
      mountPath: /etc/github-app/client_id
    - name: github-app-installation-id
      secretRef:
        name: github-app-credentials
        key: installation_id
      mountPath: /etc/github-app/installation_id
    - name: github-app-private-key
      secretRef:
        name: github-app-credentials
        key: private_key
      mountPath: /etc/github-app/private_key
      fileMode: 0400
  # Agent-level contexts (lowest priority, applied to all tasks)
  contexts:
    - type: Text
      text: |
        

          ## Temporary Files

          **Do NOT use `/tmp` directory** - some AI agents have sandbox restrictions that prevent reading files outside the workspace.

          Create temporary files **WITHIN the Git repository directory** (not in `${WORKSPACE_DIR}` root):

          ```bash
          # Correct: Create temp files inside the Git repo
          cd ${WORKSPACE_DIR}/kubeopencode  # Your repo's mountPath
          mkdir -p .tmp
          echo "some-value" > .tmp/my-temp-file
          # Later read: cat .tmp/my-temp-file

          # Wrong: Creating temp files in workspace root
          # echo "value" > ${WORKSPACE_DIR}/branch_name  # May cause path confusion!
          ```

          **Why inside the Git repo?** The Agent typically operates within the repo directory. Files created at `${WORKSPACE_DIR}/` level may be inaccessible when working inside a subdirectory.
    - type: Text
      text: |
        # GitHub Operations

        ## Quick Reference

        Two scripts are available at `${WORKSPACE_DIR}/.github-app/`:

        | Script | Purpose |
        |--------|---------|
        | `github.sh` | High-level operations (push, PR) - **use this for common tasks** |
        | `github-app-iat.sh` | Generate token for custom `gh` commands |

        ## Common Tasks (Recommended)

        **Note**: Use `bash` to execute scripts (avoids permission issues):

        ### Push and Create PR (One Command)

        ```bash
        bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr <branch> "<title>" "[body]"
        ```

        Example:
        ```bash
        bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr feature-branch "feat: add new feature" "Description here"
        ```

        ### Push Only

        ```bash
        bash ${WORKSPACE_DIR}/.github-app/github.sh push <branch>
        ```

        ### Create PR Only (branch must already be pushed)

        ```bash
        bash ${WORKSPACE_DIR}/.github-app/github.sh pr <branch> "<title>" "[body]"
        ```

        ## Custom GitHub Commands

        For commands not covered by `github.sh`, generate a token first:

        ```bash
        export GH_TOKEN=$(bash ${WORKSPACE_DIR}/.github-app/github-app-iat.sh \
          "$(cat /etc/github-app/client_id)" \
          /etc/github-app/private_key \
          "$(cat /etc/github-app/installation_id)")

        # Now use any gh command
        gh issue create --title "Bug report" --body "Description"
        gh pr comment 123 --body "LGTM!"
        gh api repos/{owner}/{repo}/issues
        ```

        **IMPORTANT**: Token generation and usage MUST be in the SAME shell command (connected with `&&`),
        because each tool call runs in a separate shell session.

        ## Troubleshooting

        ### Permission Denied Error

        If you see "Permission denied" when running scripts, fix permissions first:

        ```bash
        chmod +x ${WORKSPACE_DIR}/.github-app/*.sh
        ```

        Or use `bash` prefix (recommended - no permission needed):

        ```bash
        bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr ...
        ```

        ### Script Path Issues

        Always use the documented symlink path, not physical paths with timestamps:

        - **Correct**: `${WORKSPACE_DIR}/.github-app/github.sh`
        - **Wrong**: `/workspace/.github-app/..2025_12_21.../github.sh`

        ## Notes

        - Tokens are valid for 1 hour
        - Scripts auto-detect repository from `git remote -v`
        - Credentials are at `/etc/github-app/` (client_id, installation_id, private_key)
        - Never echo or log token values
    # GitHub scripts (from ConfigMap, mounted as executables)
    # Note: Must be within workspace because init container copies ConfigMap content
    - type: ConfigMap
      configMap:
        name: github-scripts
        # No key specified = mount all keys as files in the directory
      mountPath: .github-app
      fileMode: 493  # 0755 in decimal
