# Copyright Contributors to the KubeOpenCode project
# Agent configuration for AI agent with credentials
apiVersion: kubeopencode.io/v1alpha1
kind: Agent
metadata:
  name: bot
spec:
  agentImage: quay.io/kubeopencode/kubeopencode-agent-opencode:latest
  executorImage: quay.io/kubeopencode/kubeopencode-agent-devbox:latest
  workspaceDir: /workspace
  # command is optional - uses default: /tools/opencode run "$(cat ${WORKSPACE_DIR}/task.md)"
  serviceAccountName: kubeopencode-agent
  maxConcurrentTasks: 1
  # Rate limiting: max 50 tasks per 24 hours
  quota:
    maxTaskStarts: 50
    windowSeconds: 86400
  # OpenCode configuration using Google Gemini 2.5 Pro
  # See: https://opencode.ai/docs/providers/
  config: |
    {
      "$schema": "https://opencode.ai/config.json",
      "model": "opencode/gemini-3-flash",
      "small_model": "opencode/gemini-3-flash",
      "share": "disabled",
      "autoupdate": false
    }
  # Contexts for bot agent
  contexts:
    # Instructions for handling GitHub events
    - name: bot-instructions
      description: "Instructions for handling GitHub events"
      type: ConfigMap
      configMap:
        name: bot-instructions
    # KubeOpenCode source code repository
    - name: kubeopencode
      description: "KubeOpenCode source code repository"
      type: Git
      git:
        repository: https://github.com/kubeopencode/kubeopencode.git
        ref: main
      mountPath: kubeopencode
  credentials:
    # Mount entire secret - all keys become env vars automatically
    - name: git
      secretRef:
        name: git-settings
    - name: opencode
      secretRef:
        name: opencode-credentials
    # GitHub App credentials mounted as directory
    # The devbox image has built-in scripts that automatically use these
    # for transparent gh CLI and git authentication
    - name: github-app
      secretRef:
        name: github-bot-credentials
