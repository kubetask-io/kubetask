# Copyright Contributors to the KubeOpenCode project
# ConfigMap containing instructions for automated tiny refactoring operations.
apiVersion: v1
kind: ConfigMap
metadata:
  name: refactor-instructions
data:
  # =============================================================================
  # REFACTORING: Guidelines and priorities for tiny refactoring tasks
  # =============================================================================
  refactoring-guidelines.md: |
    # Tiny Refactoring Guidelines

    ## About This Task

    You are an automated refactoring agent for the KubeOpenCode project.
    Your goal is to identify and implement **ONE small, safe refactoring**
    that improves code quality without changing behavior.

    ## Core Principles

    1. **Tiny and Low-Risk**: Each change should be small and obviously safe
    2. **Behavior Preservation**: Code must work exactly the same before and after
    3. **One Change Per Run**: Focus on a single refactoring operation
    4. **Test Verification**: Always run tests to confirm no behavior change
    5. **Tool-Assisted Discovery**: Use static analysis tools to find issues

    ## Step 0: Use Static Analysis First

    Before manual scanning, run these tools to find obvious issues:

    ```bash
    cd kubeopencode

    # Find unused code, shadowed variables, etc.
    go vet ./...

    # Find dead code, unused parameters (if available)
    staticcheck ./... 2>/dev/null || true

    # Check for inefficient code patterns
    golangci-lint run --no-config --disable-all \
      --enable=unused,deadcode,ineffassign,unconvert \
      ./... 2>/dev/null || true
    ```

    If tools report issues, prioritize fixing those first (they are verified safe).

    ## Refactoring Priority Order

    After running static analysis, choose the FIRST applicable refactoring type:

    ### Priority 1: Dead Code Removal (Safest)
    - Unused imports (often caught by `go vet`)
    - Unused variables (often caught by compiler)
    - Unused private functions (unexported functions with no callers)
    - Commented-out code blocks (>5 lines, not TODOs)

    ### Priority 2: Naming Improvements
    - Single-letter variable names in functions >10 lines (except `i`, `j`, `k` for loops, `t` for testing.T, `r` for http.Request, `w` for http.ResponseWriter)
    - Misleading names (e.g., `list` that is actually a map)
    - Inconsistent patterns (e.g., mixing `Get`/`Fetch` for same concept)

    ### Priority 3: Magic Values
    Extract to named constants when:
    - Numbers appear 2+ times with same meaning
    - Numbers have non-obvious meaning (NOT: 0, 1, -1, 100 for percentages)
    - Strings are repeated 3+ times
    - Timeout/duration values without context

    **Exceptions (do NOT extract):**
    - `0`, `1`, `-1` (universal meanings)
    - Array/slice indices
    - Percentage values (0-100)
    - HTTP status codes in tests
    - Struct field defaults

    ### Priority 4: Code Simplification
    - Boolean expressions with >2 operators: simplify or extract to named function
    - Nesting depth >3 levels: use early returns
    - `if err != nil { return err }` chains: consider helper if >5 consecutive

    ### Priority 5: Small Extractions
    - Functions >50 lines with logically separable blocks
    - Duplicate code fragments (>8 lines appearing 2+ times)
    - Complex inline expressions that deserve a name

    ## What NOT to Refactor

    - **Public APIs**: Do not change exported types/functions in `api/` directory
    - **Generated Code**: Skip `zz_generated*`, `*_generated.go`
    - **Vendor Code**: Skip `vendor/` directory
    - **Test Data**: Skip `testdata/`, golden files, fixtures
    - **Configuration**: Skip YAML/JSON/TOML files
    - **Documentation**: Skip markdown files, comments explaining "why"
    - **Recently Changed**: Skip files modified in last 5 commits (avoid conflicts)

    ## File Focus

    Prefer refactoring in these directories (in order):
    1. `internal/controller/` - Controller logic (highest impact)
    2. `cmd/kubeopencode/` - CLI commands
    3. `pkg/` - Shared packages (if any)

    Skip these even if issues found:
    - `e2e/` - E2E test scaffolding
    - `hack/` - Build scripts

  # =============================================================================
  # WORKFLOW: Step-by-step process for refactoring
  # =============================================================================
  workflow.md: |
    # Refactoring Workflow

    ## Step 1: Discover and Choose

    ```bash
    cd kubeopencode
    ```

    1. Run static analysis tools (see Step 0 in guidelines)
    2. If tools find issues, pick the first one
    3. If no tool findings, manually scan following priority order
    4. Choose exactly ONE refactoring to implement

    Before proceeding, verify:
    - [ ] The change is in an allowed directory
    - [ ] The file was not modified in recent commits: `git log -5 --oneline -- <file>`
    - [ ] You understand the code's purpose

    ## Step 2: Implement

    1. Create branch:
       ```bash
       git checkout -b refactor/$(date +%Y%m%d)-<short-description>
       ```

    2. Make the minimal change required

    3. Self-check before committing:
       - Does this change behavior? If unsure, STOP
       - Is this the smallest possible change?
       - Would a reviewer understand this immediately?

    ## Step 3: Verify

    Run verification in order (stop on first failure):

    ```bash
    # 1. Code compiles
    go build ./...

    # 2. Linter passes
    make lint

    # 3. Tests pass
    make test
    ```

    ### On Failure: Rollback Procedure

    If ANY verification step fails:

    ```bash
    # Discard all uncommitted changes
    git checkout -- .

    # Remove any new untracked files
    git clean -fd

    # Return to main branch
    git checkout main

    # Delete the failed branch
    git branch -D refactor/$(date +%Y%m%d)-<short-description>
    ```

    Then either:
    - Try a different, safer refactoring
    - Exit with "no safe refactoring found" (see no-refactoring.md)

    **Do NOT attempt to fix failing tests** - that changes behavior.

    ## Step 4: Commit and PR

    ```bash
    # Commit with signoff
    git add -A
    git commit -s -m "refactor(<scope>): <what changed>

    <why this improves the code - one line>

    Type: <Priority N: Category Name>"

    # Push and create PR
    git push -u origin HEAD
    gh pr create \
      --title "refactor(<scope>): <what changed>" \
      --body "**Type:** <Priority N: Category Name>

    **Change:** <one sentence>

    **Why:** <one sentence>

    **Verified:** go build, make lint, make test all pass

    ---
    _Automated by kubeopencode-refactor_" \
      --label "refactor" \
      --label "automated"
    ```

    **Scope examples:** `controller`, `cli`, `api`, `pkg`

  # =============================================================================
  # NO-OP: What to do when no refactoring is found
  # =============================================================================
  no-refactoring.md: |
    # No Refactoring Found

    If you cannot find any safe refactoring:

    1. **Do not force a change** - quality over quantity
    2. **Do not create an issue** - no-op is normal and expected
    3. **Exit cleanly** with a brief summary:

    ```
    Refactoring scan complete. No safe refactoring opportunities found.

    Checked:
    - Static analysis: no actionable issues
    - Priority 1-5 categories: no applicable changes

    This is normal for a well-maintained codebase.
    ```

    The task succeeds even without a PR.

  # =============================================================================
  # SAFETY: Hard rules that cannot be overridden
  # =============================================================================
  safety-rules.md: |
    # Safety Rules (Non-Negotiable)

    These rules MUST be followed. No exceptions.

    ## Absolute Prohibitions

    1. **Never change function signatures** of exported functions
    2. **Never modify struct field names** or types
    3. **Never change error messages** that might be parsed by callers
    4. **Never reorder struct fields** (can break serialization)
    5. **Never rename packages**
    6. **Never modify constants** that might be referenced externally

    ## Size Limits

    - Maximum files changed: 3
    - Maximum lines changed: 50
    - Maximum functions modified: 5

    If your refactoring exceeds these limits, it's too big. Split it up.

    ## Uncertainty = Stop

    If you're unsure whether a change is safe:
    - STOP immediately
    - Do NOT proceed "to see what happens"
    - Choose a different, obviously safe refactoring
    - Or exit with no changes

    ## Verification is Mandatory

    Never skip `go build`, `make lint`, or `make test`.
    If any command fails, the refactoring is rejected.
