# Copyright Contributors to the KubeOpenCode project
# ConfigMap containing GitHub App scripts
# - github-app-iat.sh: Generate Installation Access Token (for custom gh commands)
# - github.sh: High-level operations (push, PR creation)
apiVersion: v1
kind: ConfigMap
metadata:
  name: github-scripts
  labels:
    app.kubernetes.io/name: kubeopencode
data:
  # Script 1: Generate GitHub App Installation Access Token
  # Usage: github-app-iat.sh <client_id> <private_key_file> <installation_id>
  # Output: Token string (for use with GH_TOKEN or git URLs)
  github-app-iat.sh: |
    #!/usr/bin/env bash
    # Generate GitHub App Installation Access Token
    # Based on: https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app

    set -e

    client_id=$1
    pem_file=$2
    installation_id=$3

    if [[ -z "$client_id" || -z "$pem_file" || -z "$installation_id" ]]; then
        echo "Usage: $0 <client_id> <private_key_file> <installation_id>" >&2
        exit 1
    fi

    pem=$(cat "$pem_file")

    now=$(date +%s)
    iat=$((now - 60))
    exp=$((now + 600))

    b64enc() { openssl base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n'; }

    header=$(echo -n '{"typ":"JWT","alg":"RS256"}' | b64enc)
    payload=$(echo -n "{\"iat\":${iat},\"exp\":${exp},\"iss\":\"${client_id}\"}" | b64enc)
    header_payload="${header}.${payload}"
    signature=$(openssl dgst -sha256 -sign <(echo -n "${pem}") <(echo -n "${header_payload}") | b64enc)
    jwt="${header_payload}.${signature}"

    response=$(curl -s -X POST \
        -H "Authorization: Bearer ${jwt}" \
        -H "Accept: application/vnd.github+json" \
        "https://api.github.com/app/installations/${installation_id}/access_tokens")

    if echo "$response" | grep -q '"message"'; then
        echo "Error: $(echo "$response" | jq -r '.message')" >&2
        exit 1
    fi

    echo "$response" | jq -r '.token'

  # Script 2: GitHub Operations (push, PR creation)
  # Usage:
  #   github.sh push <branch>
  #   github.sh pr <branch> <title> [body]
  #   github.sh push-and-pr <branch> <title> [body]
  github.sh: |
    #!/usr/bin/env bash
    # GitHub Operations Script - push and PR creation using GitHub App IAT

    set -e

    # Scripts directory (same directory as this script)
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

    # Ensure all scripts in this directory are executable
    # (workaround for ConfigMap mount permission issues)
    chmod +x "$SCRIPT_DIR"/*.sh 2>/dev/null || true
    # Credentials directory (secrets mounted here)
    GITHUB_APP_DIR="${GITHUB_APP_DIR:-/etc/github-app}"
    # IAT script is in the same directory as this script
    IAT_SCRIPT="${SCRIPT_DIR}/github-app-iat.sh"

    # Colors (disabled if not a terminal)
    if [ -t 1 ]; then
        RED='\033[0;31m'; GREEN='\033[0;32m'; NC='\033[0m'
    else
        RED=''; GREEN=''; NC=''
    fi

    log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
    log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

    generate_token() {
        if [ ! -f "$IAT_SCRIPT" ]; then
            log_error "IAT script not found at $IAT_SCRIPT"
            exit 1
        fi

        local client_id_file="${GITHUB_APP_DIR}/client_id"
        local private_key_file="${GITHUB_APP_DIR}/private_key"
        local installation_id_file="${GITHUB_APP_DIR}/installation_id"

        for file in "$client_id_file" "$private_key_file" "$installation_id_file"; do
            if [ ! -f "$file" ]; then
                log_error "Required file not found: $file"
                exit 1
            fi
        done

        local token
        token=$("$IAT_SCRIPT" "$(cat "$client_id_file")" "$private_key_file" "$(cat "$installation_id_file")")

        if [ -z "$token" ]; then
            log_error "Failed to generate GitHub App token"
            exit 1
        fi

        echo "$token"
    }

    get_repo_path() {
        local remote_url=$(git remote get-url origin 2>/dev/null)
        if [ -z "$remote_url" ]; then
            log_error "Failed to get git remote URL"
            exit 1
        fi

        # Extract org/repo from GitHub URL (https or ssh format)
        # Remove https://github.com/ prefix
        local repo_path=$(echo "$remote_url" | sed 's#^https://github\.com/##' | sed 's#^git@github\.com:##' | sed 's#\.git$##')

        if [ -z "$repo_path" ] || [[ "$repo_path" != *"/"* ]]; then
            log_error "Failed to parse repo path from: $remote_url"
            exit 1
        fi

        echo "$repo_path"
    }

    get_default_branch() {
        local branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
        [ -z "$branch" ] && branch=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | awk '{print $NF}')
        echo "${branch:-main}"
    }

    do_push() {
        local branch="$1"
        [ -z "$branch" ] && { log_error "Usage: $0 push <branch>"; exit 1; }

        log_info "Generating token..."
        local token=$(generate_token)

        local repo_path=$(get_repo_path)
        log_info "Repository: $repo_path"

        log_info "Pushing branch '$branch'..."
        local push_url="https://x-access-token:${token}@github.com/${repo_path}.git"

        if git push "$push_url" "$branch" 2>&1; then
            log_info "Successfully pushed '$branch'"
        else
            log_error "Failed to push '$branch'"
            exit 1
        fi
    }

    do_pr() {
        local branch="$1"
        local title="$2"
        local body="${3:-Created by KubeOpenCode Agent}"

        [ -z "$branch" ] || [ -z "$title" ] && { log_error "Usage: $0 pr <branch> <title> [body]"; exit 1; }

        log_info "Generating token..."
        local token=$(generate_token)
        export GH_TOKEN="$token"

        local repo_path=$(get_repo_path)
        local default_branch=$(get_default_branch)
        log_info "Creating PR: $branch -> $default_branch"

        local pr_url=$(gh pr create --repo "$repo_path" --head "$branch" --base "$default_branch" --title "$title" --body "$body" 2>&1)

        if [ $? -eq 0 ]; then
            log_info "Created PR: $pr_url"
            echo "$pr_url"
        else
            log_error "Failed to create PR: $pr_url"
            exit 1
        fi
    }

    do_push_and_pr() {
        local branch="$1"
        local title="$2"
        local body="${3:-Created by KubeOpenCode Agent}"

        [ -z "$branch" ] || [ -z "$title" ] && { log_error "Usage: $0 push-and-pr <branch> <title> [body]"; exit 1; }

        log_info "Generating token..."
        local token=$(generate_token)

        local repo_path=$(get_repo_path)
        log_info "Repository: $repo_path"

        log_info "Pushing branch '$branch'..."
        local push_url="https://x-access-token:${token}@github.com/${repo_path}.git"

        if ! git push "$push_url" "$branch" 2>&1; then
            log_error "Failed to push '$branch'"
            exit 1
        fi
        log_info "Successfully pushed '$branch'"

        export GH_TOKEN="$token"
        local default_branch=$(get_default_branch)
        log_info "Creating PR: $branch -> $default_branch"

        local pr_url=$(gh pr create --repo "$repo_path" --head "$branch" --base "$default_branch" --title "$title" --body "$body" 2>&1)

        if [ $? -eq 0 ]; then
            log_info "Created PR: $pr_url"
            echo "$pr_url"
        else
            log_error "Failed to create PR: $pr_url"
            exit 1
        fi
    }

    case "${1:-}" in
        push)       shift; do_push "$@" ;;
        pr)         shift; do_pr "$@" ;;
        push-and-pr) shift; do_push_and_pr "$@" ;;
        *)
            echo "GitHub Operations Script"
            echo ""
            echo "Usage:"
            echo "  $0 push <branch>                       Push branch to GitHub"
            echo "  $0 pr <branch> <title> [body]          Create PR"
            echo "  $0 push-and-pr <branch> <title> [body] Push and create PR"
            exit 1
            ;;
    esac
