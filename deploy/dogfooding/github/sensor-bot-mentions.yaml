# Copyright Contributors to the KubeOpenCode project
# Sensor that creates KubeOpenCode Tasks in response to @kubeopencode-bot mentions.
#
# This sensor handles ALL comment types where @kubeopencode-bot is mentioned:
# - Issue comments
# - PR comments (issue-level)
# - PR review comments (inline)
# - Discussion comments
#
# The template uses conditionals to include the appropriate context based on
# the event type, and references the correct instruction file.
#
# Note: This bot agent has read-only GitHub permissions (no code write access).
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-bot-mentions
spec:
  eventBusName: default
  template:
    serviceAccountName: argo-events-sensor
  dependencies:
    - name: bot-mention
      eventSourceName: github-bot
      eventName: kubeopencode
      filters:
        # Filter for any comment event with @kubeopencode-bot mention
        # Using regex to match the mention anywhere in the comment body
        data:
          - path: body.action
            type: string
            value:
              - created
          - path: body.comment.body
            type: string
            value:
              # Regex pattern to match @kubeopencode-bot anywhere in text
              - ".*@kubeopencode-bot.*"
          # Exclude bot's own comments to prevent recursive triggers
          - path: body.comment.user.login
            type: string
            comparator: "!="
            value:
              - kubeopencode-bot[bot]
  triggers:
    - template:
        name: bot-mention
        conditions: bot-mention
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-bot-mention-
                labels: {}
                annotations: {}
              spec:
                agentRef:
                  name: bot
                  namespace: kubeopencode-dogfooding
                description: ""
          parameters:
            # Labels for filtering
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ index (index .Input.headers \"X-Github-Event\") 0 }}"
              dest: metadata.labels.github\.kubeopencode\.io/event
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ .Input.body.repository.name }}"
              dest: metadata.labels.github\.kubeopencode\.io/repository
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ if .Input.body.issue }}{{ .Input.body.issue.number }}{{ else if .Input.body.pull_request }}{{ .Input.body.pull_request.number }}{{ else if .Input.body.discussion }}{{ .Input.body.discussion.number }}{{ end }}"
              dest: metadata.labels.github\.kubeopencode\.io/number
            # Annotations for detailed info
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ .Input.body.action }}"
              dest: metadata.annotations.github\.kubeopencode\.io/action
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ .Input.body.repository.full_name }}"
              dest: metadata.annotations.github\.kubeopencode\.io/full-name
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ .Input.body.comment.user.login }}"
              dest: metadata.annotations.github\.kubeopencode\.io/author
            - src:
                dependencyName: bot-mention
                dataTemplate: "{{ .Input.body.comment.html_url }}"
              dest: metadata.annotations.github\.kubeopencode\.io/url
            # Description
            - src:
                dependencyName: bot-mention
                dataTemplate: |
                  # GitHub Event: @kubeopencode-bot Mention

                  ## Event Type
                  - GitHub Event: {{ index (index .Input.headers "X-Github-Event") 0 }}
                  - Action: {{ .Input.body.action }}

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}
                  - Owner: {{ .Input.body.repository.owner.login }}
                  - Name: {{ .Input.body.repository.name }}

                  {{ if .Input.body.issue }}
                  ## Issue/PR Context
                  - Number: {{ .Input.body.issue.number }}
                  - Title: {{ .Input.body.issue.title }}
                  - URL: {{ .Input.body.issue.html_url }}
                  - State: {{ .Input.body.issue.state }}
                  {{ if .Input.body.issue.pull_request }}
                  - Type: Pull Request
                  {{ else }}
                  - Type: Issue
                  {{ end }}
                  {{ end }}

                  {{ if .Input.body.pull_request }}
                  ## Pull Request Context
                  - Number: {{ .Input.body.pull_request.number }}
                  - Title: {{ .Input.body.pull_request.title }}
                  - URL: {{ .Input.body.pull_request.html_url }}
                  {{ end }}

                  {{ if .Input.body.discussion }}
                  ## Discussion Context
                  - Number: {{ .Input.body.discussion.number }}
                  - Title: {{ .Input.body.discussion.title }}
                  - URL: {{ .Input.body.discussion.html_url }}
                  - Category: {{ .Input.body.discussion.category.name }}
                  {{ end }}

                  {{ if .Input.body.comment.path }}
                  ## Review Comment Location
                  - File: {{ .Input.body.comment.path }}
                  - Line: {{ .Input.body.comment.line }}
                  {{ end }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**:
                  {{ if .Input.body.discussion }}
                  Follow `.instructions/comment-discussion.md`
                  {{ else if .Input.body.comment.path }}
                  Follow `.instructions/comment-pr-review.md`
                  {{ else if .Input.body.issue.pull_request }}
                  Follow `.instructions/comment-pr.md`
                  {{ else if .Input.body.issue }}
                  Follow `.instructions/comment-issue.md`
                  {{ else }}
                  Follow `.instructions/comment.md`
                  {{ end }}

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - OWNER={{ .Input.body.repository.owner.login }}
                  - REPO_NAME={{ .Input.body.repository.name }}
                  {{ if .Input.body.issue }}
                  - NUMBER={{ .Input.body.issue.number }}
                  {{ else if .Input.body.pull_request }}
                  - NUMBER={{ .Input.body.pull_request.number }}
                  {{ else if .Input.body.discussion }}
                  - NUMBER={{ .Input.body.discussion.number }}
                  {{ end }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
                  {{ if .Input.body.comment.path }}
                  - FILE_PATH={{ .Input.body.comment.path }}
                  - LINE={{ .Input.body.comment.line }}
                  {{ end }}
              dest: spec.description
