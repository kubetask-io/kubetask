# Copyright Contributors to the KubeOpenCode project
# Sensor that creates KubeOpenCode Tasks in response to GitHub events.
# This sensor handles privileged users (OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR)
# and uses the dev agent which has GitHub content write permissions.
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-dev
spec:
  eventBusName: default
  template:
    serviceAccountName: argo-events-sensor
  dependencies:
    - name: github-event
      eventSourceName: github-dev
      eventName: kubeopencode
  triggers:
    # Rule 1: Issue comment from privileged user
    - template:
        name: comment-issue
        conditions: comment-issue-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-dev-comment-issue-
                namespace: kubeopencode-system
              spec:
                agentRef:
                  name: dev
                  namespace: kubeopencode-system
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # GitHub Event: Issue Comment (Privileged User)

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}

                  ## Issue
                  - Number: {{ .Input.body.issue.number }}
                  - Title: {{ .Input.body.issue.title }}
                  - URL: {{ .Input.body.issue.html_url }}
                  - State: {{ .Input.body.issue.state }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**: Follow `.instructions/comment-issue.md`

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - CLONE_URL={{ .Input.body.repository.clone_url }}
                  - NUMBER={{ .Input.body.issue.number }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
              dest: spec.description

    # Rule 2: PR comment (issue-level) from privileged user
    - template:
        name: comment-pr
        conditions: comment-pr-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-dev-comment-pr-
                namespace: kubeopencode-system
              spec:
                agentRef:
                  name: dev
                  namespace: kubeopencode-system
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # GitHub Event: PR Comment (Privileged User)

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}

                  ## Pull Request
                  - Number: {{ .Input.body.issue.number }}
                  - Title: {{ .Input.body.issue.title }}
                  - URL: {{ .Input.body.issue.html_url }}
                  - State: {{ .Input.body.issue.state }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**: Follow `.instructions/comment-pr.md`

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - CLONE_URL={{ .Input.body.repository.clone_url }}
                  - NUMBER={{ .Input.body.issue.number }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
              dest: spec.description

    # Rule 3: PR review comment (inline) from privileged user
    - template:
        name: comment-pr-review
        conditions: comment-pr-review-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-dev-comment-pr-review-
                namespace: kubeopencode-system
              spec:
                agentRef:
                  name: dev
                  namespace: kubeopencode-system
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # GitHub Event: PR Review Comment (Privileged User)

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}

                  ## Pull Request
                  - Number: {{ .Input.body.pull_request.number }}
                  - Title: {{ .Input.body.pull_request.title }}
                  - URL: {{ .Input.body.pull_request.html_url }}

                  ## Review Comment Location
                  - File: {{ .Input.body.comment.path }}
                  - Line: {{ .Input.body.comment.line }}
                  - Diff Hunk: {{ .Input.body.comment.diff_hunk }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**: Follow `.instructions/comment-pr-review.md`

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - CLONE_URL={{ .Input.body.repository.clone_url }}
                  - NUMBER={{ .Input.body.pull_request.number }}
                  - FILE_PATH={{ .Input.body.comment.path }}
                  - LINE={{ .Input.body.comment.line }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
              dest: spec.description

    # Rule 4: Discussion comment from privileged user
    - template:
        name: comment-discussion
        conditions: comment-discussion-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-dev-comment-discussion-
                namespace: kubeopencode-system
              spec:
                agentRef:
                  name: dev
                  namespace: kubeopencode-system
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # GitHub Event: Discussion Comment (Privileged User)

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}
                  - Owner: {{ .Input.body.repository.owner.login }}
                  - Name: {{ .Input.body.repository.name }}

                  ## Discussion
                  - Number: {{ .Input.body.discussion.number }}
                  - Title: {{ .Input.body.discussion.title }}
                  - URL: {{ .Input.body.discussion.html_url }}
                  - Category: {{ .Input.body.discussion.category.name }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**: Follow `.instructions/comment-discussion.md`

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - CLONE_URL={{ .Input.body.repository.clone_url }}
                  - OWNER={{ .Input.body.repository.owner.login }}
                  - REPO_NAME={{ .Input.body.repository.name }}
                  - NUMBER={{ .Input.body.discussion.number }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
              dest: spec.description

  # Conditions for filtering events
  # Note: Argo Events uses expr-lang expressions, not CEL
  # See: https://expr.medv.io/docs/Language-Definition
  #
  # Privileged users: OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR
  conditions:
    # Issue comment (not PR) from privileged user
    - name: comment-issue-condition
      expression: >-
        Input.headers["X-Github-Event"] == "issue_comment" &&
        Input.body.action == "created" &&
        Input.body.issue.pull_request == nil &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "OWNER" ||
         Input.body.comment.author_association == "MEMBER" ||
         Input.body.comment.author_association == "CONTRIBUTOR" ||
         Input.body.comment.author_association == "COLLABORATOR")

    # PR comment (issue-level, not review) from privileged user
    - name: comment-pr-condition
      expression: >-
        Input.headers["X-Github-Event"] == "issue_comment" &&
        Input.body.action == "created" &&
        Input.body.issue.pull_request != nil &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "OWNER" ||
         Input.body.comment.author_association == "MEMBER" ||
         Input.body.comment.author_association == "CONTRIBUTOR" ||
         Input.body.comment.author_association == "COLLABORATOR")

    # PR review comment (inline) from privileged user
    - name: comment-pr-review-condition
      expression: >-
        Input.headers["X-Github-Event"] == "pull_request_review_comment" &&
        Input.body.action == "created" &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "OWNER" ||
         Input.body.comment.author_association == "MEMBER" ||
         Input.body.comment.author_association == "CONTRIBUTOR" ||
         Input.body.comment.author_association == "COLLABORATOR")

    # Discussion comment from privileged user
    - name: comment-discussion-condition
      expression: >-
        Input.headers["X-Github-Event"] == "discussion_comment" &&
        Input.body.action == "created" &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "OWNER" ||
         Input.body.comment.author_association == "MEMBER" ||
         Input.body.comment.author_association == "CONTRIBUTOR" ||
         Input.body.comment.author_association == "COLLABORATOR")
