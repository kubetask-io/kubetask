# Copyright Contributors to the KubeOpenCode project
# Sensor that creates KubeOpenCode Tasks in response to GitHub events.
# This replaces the WebhookTrigger CRD functionality.
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-tasks
  namespace: kubeopencode-system
spec:
  eventBusName: default
  template:
    serviceAccountName: argo-events-sensor
  dependencies:
    - name: github-event
      eventSourceName: github
      eventName: kubeopencode
  triggers:
    # Rule 1: PR opened - auto review
    - template:
        name: pr-opened
        conditions: pr-opened-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-pr-opened-
                namespace: kubeopencode-system
              spec:
                agentRef: default
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  Review this Pull Request and post your review as a comment:

                  Repository: {{ .Input.body.repository.full_name }}
                  Author: {{ .Input.body.sender.login }}

                  PR #{{ .Input.body.pull_request.number }}: {{ .Input.body.pull_request.title }}
                  PR URL: {{ .Input.body.pull_request.html_url }}
                  PR Body: {{ .Input.body.pull_request.body }}

                  ## Instructions

                  ### Step 1: Clone and Checkout

                  Clone the repository and checkout the PR branch:
                  ```bash
                  gh pr checkout {{ .Input.body.pull_request.number }}
                  ```

                  ### Step 2: Get Changed Files and Diff

                  Get the list of changed files and the full diff:
                  ```bash
                  gh pr diff {{ .Input.body.pull_request.number }} --name-only
                  gh pr diff {{ .Input.body.pull_request.number }}
                  ```

                  ### Step 3: Review Each Changed File

                  For each changed file, analyze the code and collect issues. Note for each issue:
                  - File path (relative to repo root)
                  - Line number (MUST be a line that was ADDED or MODIFIED in the PR - lines with `+` prefix in diff)
                  - Issue description

                  Look for:
                  - Code quality issues
                  - Potential bugs
                  - Security vulnerabilities
                  - Style/convention violations
                  - Missing error handling
                  - Performance concerns

                  ### Step 4: Submit Review with Inline Comments

                  Use the GitHub API to submit a PR review with inline comments on specific code lines:

                  **IMPORTANT**: The `line` parameter MUST be a line number from the NEW version of the file (right side of diff). Only comment on lines that were added (+) or modified in the PR.

                  ```bash
                  gh api repos/{{ .Input.body.repository.full_name }}/pulls/{{ .Input.body.pull_request.number }}/reviews \
                    -f event="COMMENT" \
                    -f body="## PR Review Summary

                  ### Overview
                  [Brief summary of what this PR does]

                  ### Code Quality
                  [Overall assessment]

                  ### Suggestions
                  [High-level recommendations if any]

                  ---
                  *Review by @kubeopencode-bot*" \
                    -f 'comments[0][path]=path/to/file.go' \
                    -f 'comments[0][line]=42' \
                    -f 'comments[0][body]=Your inline comment here'
                  ```

                  If you find multiple issues, add more comment entries:
                  ```bash
                  -f 'comments[1][path]=another/file.go' \
                  -f 'comments[1][line]=15' \
                  -f 'comments[1][body]=Another issue'
                  ```

                  ### Step 5: If No Issues Found

                  If no specific code issues are found, submit a review with only the summary (no inline comments):
                  ```bash
                  gh api repos/{{ .Input.body.repository.full_name }}/pulls/{{ .Input.body.pull_request.number }}/reviews \
                    -f event="COMMENT" \
                    -f body="## PR Review Summary

                  [Your review summary here - what the PR does, overall quality assessment]

                  ---
                  *Review by @kubeopencode-bot*"
                  ```
              dest: spec.description

    # Rule 2: @kubeopencode-bot mention from privileged users (OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR)
    - template:
        name: comment-privileged
        conditions: comment-privileged-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-comment-privileged-
                namespace: kubeopencode-system
              spec:
                agentRef: default
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # @kubeopencode-bot Mention Handler (Privileged User)

                  ## Event Details

                  - Repository: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}
                  {{- if .Input.body.issue }}
                  - Event Type: Issue/PR Comment
                  - Issue/PR #{{ .Input.body.issue.number }}: {{ .Input.body.issue.title }}
                  - Issue/PR URL: {{ .Input.body.issue.html_url }}
                  - Is PR: {{ if .Input.body.issue.pull_request }}Yes{{ else }}No{{ end }}
                  {{- else if .Input.body.pull_request }}
                  - Event Type: PR Review Comment
                  - PR #{{ .Input.body.pull_request.number }}: {{ .Input.body.pull_request.title }}
                  - PR URL: {{ .Input.body.pull_request.html_url }}
                  - Is PR: Yes
                  {{- else if .Input.body.discussion }}
                  - Event Type: Discussion Comment
                  - Discussion #{{ .Input.body.discussion.number }}: {{ .Input.body.discussion.title }}
                  - Discussion URL: {{ .Input.body.discussion.html_url }}
                  - Category: {{ .Input.body.discussion.category.name }}
                  {{- end }}

                  ## Comment Details

                  - Commenter: @{{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - Comment URL: {{ .Input.body.comment.html_url }}
                  {{- if .Input.body.pull_request }}
                  - File: {{ .Input.body.comment.path }}
                  - Line: {{ .Input.body.comment.line }}
                  {{- end }}

                  ### Comment Body

                  {{ .Input.body.comment.body }}

                  ## Instructions

                  You are @kubeopencode-bot responding to a mention from a **privileged user** ({{ .Input.body.comment.author_association }}).

                  ### Step 0: Gather Full Context (REQUIRED BEFORE RESPONDING)

                  Before analyzing the user's request, you MUST read the full context to understand the conversation history.

                  {{- if .Input.body.issue }}
                  **For Issue/PR Comments:**
                  1. Clone the repository first
                  2. Get the full issue/PR description and all previous comments:
                     ```bash
                     gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} view {{ .Input.body.issue.number }} --comments
                     ```
                  3. If this is a PR, checkout the PR branch to access the code locally:
                     ```bash
                     gh pr checkout {{ .Input.body.issue.number }}
                     ```
                  {{- else if .Input.body.pull_request }}
                  **For PR Review Comments:**
                  1. Clone the repository and checkout the PR:
                     ```bash
                     gh pr checkout {{ .Input.body.pull_request.number }}
                     ```
                  2. Get the full PR description and all issue-level comments:
                     ```bash
                     gh pr view {{ .Input.body.pull_request.number }} --comments
                     ```
                  3. Get all review comments on this PR:
                     ```bash
                     gh api repos/{{ .Input.body.repository.full_name }}/pulls/{{ .Input.body.pull_request.number }}/comments --jq '.[] | "[\(.user.login) on \(.path):\(.line)] \(.body)"'
                     ```
                  {{- else if .Input.body.discussion }}
                  **For Discussion Comments:**
                  1. Clone the repository first
                  2. Get the full discussion with all replies:
                     ```bash
                     gh api graphql -f query='
                       query {
                         repository(owner: "{{ .Input.body.repository.owner.login }}", name: "{{ .Input.body.repository.name }}") {
                           discussion(number: {{ .Input.body.discussion.number }}) {
                             title
                             body
                             comments(first: 100) {
                               nodes {
                                 author { login }
                                 body
                                 replies(first: 50) {
                                   nodes {
                                     author { login }
                                     body
                                   }
                                 }
                               }
                             }
                           }
                         }
                       }
                     '
                     ```
                  {{- end }}

                  **IMPORTANT**: Read and understand the full context before proceeding to Step 1. Your response should demonstrate awareness of the entire conversation, not just the triggering comment.

                  ### Step 1: Analyze Intent

                  Read the comment carefully and determine what the user is asking:
                  - **Question**: User is asking about the code, seeking explanation, or asking for help
                  - **Code Change Request**: User is EXPLICITLY asking you to modify, fix, add, update, or remove code (must contain clear action words like "please fix", "can you update", "add X to Y", etc.)
                  - **No Clear Request**: User just mentioned @kubeopencode-bot without a specific question or request

                  **IMPORTANT**: If the comment only contains "@kubeopencode-bot" or a simple greeting without a clear ask, treat it as "No Clear Request". Do NOT assume the user wants code changes.

                  ### Step 2: For Questions

                  If the user is asking a question:
                  1. Clone the repository
                  {{- if .Input.body.discussion }}
                  2. Checkout the default branch
                  3. Read and analyze the relevant code
                  4. Reply with your answer using: `gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="..."`
                  {{- else if .Input.body.pull_request }}
                  2. Checkout the PR branch: `gh pr checkout {{ .Input.body.pull_request.number }}`
                  3. Read and analyze the relevant code (especially {{ .Input.body.comment.path }} around line {{ .Input.body.comment.line }})
                  4. Reply with your answer using: `gh pr comment {{ .Input.body.pull_request.number }} --body "..."`
                  {{- else if .Input.body.issue }}
                  2. {{ if .Input.body.issue.pull_request }}Checkout the PR branch: `gh pr checkout {{ .Input.body.issue.number }}`{{ else }}Checkout the default branch{{ end }}
                  3. Read and analyze the relevant code
                  4. Reply with your answer using: `gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "..."`
                  {{- end }}

                  ### Step 2b: For No Clear Request

                  If the user just mentioned you without a clear question or request:
                  1. Acknowledge the mention
                  2. Ask what they need help with
                  3. **DO NOT** make any code changes
                  {{- if .Input.body.discussion }}
                  4. Reply using: `gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="..."`
                  {{- else if .Input.body.pull_request }}
                  4. Reply using: `gh pr comment {{ .Input.body.pull_request.number }} --body "..."`
                  {{- else if .Input.body.issue }}
                  4. Reply using: `gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "..."`
                  {{- end }}

                  Example response:
                  ```
                  {{- if .Input.body.discussion }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me. How can I help you with this discussion?
                  {{- else if .Input.body.pull_request }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me in this PR review comment. How can I help you?
                  {{- else if .Input.body.issue }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me. How can I help you with this {{ if .Input.body.issue.pull_request }}PR{{ else }}issue{{ end }}?
                  {{- end }}

                  I can:
                  - Answer questions about the code
                  - Review changes
                  - Make code modifications (if you describe what you need)

                  Just let me know what you'd like me to do!
                  ```

                  ### Step 3: For Code Change Requests

                  **ONLY proceed with code changes if the user EXPLICITLY requested them.** Look for clear action words like:
                  - "please fix...", "can you update...", "add X to...", "remove...", "change..."

                  If you're unsure whether the user wants code changes, ask for clarification first.

                  {{- if .Input.body.discussion }}
                  This is a discussion comment. For code change requests in discussions:
                  1. Clone the repository and create a new branch
                  2. Make the requested changes
                  3. Commit with signoff: `git commit -s -m "fix: <description>"`
                  4. Push the branch and create a PR, then enable auto-merge:
                     ```bash
                     git push -u origin <branch-name>
                     gh pr create --title "<title>" --body "<description>"
                     gh pr merge --auto --squash
                     ```
                  5. Reply with the PR link
                  {{- else if .Input.body.pull_request }}
                  If the user is requesting code changes on this PR review comment:

                  1. First, check if this PR is from a fork:
                     ```bash
                     gh pr view {{ .Input.body.pull_request.number }} --json headRepositoryOwner,baseRepository --jq '{head: .headRepositoryOwner.login, base: .baseRepository.owner.login}'
                     ```

                  2. **If same-repo PR** (head owner == base owner):
                     - Checkout the PR branch: `gh pr checkout {{ .Input.body.pull_request.number }}`
                     - Make the requested changes (especially in {{ .Input.body.comment.path }} around line {{ .Input.body.comment.line }})
                     - Commit with signoff: `git commit -s -m "fix: <description>"`
                     - Push the changes
                     - Reply confirming the changes were made

                  3. **If fork PR** (different owners):
                     - Reply explaining: "This PR is from a fork. I cannot directly push to fork PRs. Please make the changes locally, or a maintainer with write access to your fork can assist."
                  {{- else if .Input.body.issue }}
                  {{ if .Input.body.issue.pull_request }}
                  If the user is requesting code changes on this PR:

                  1. First, check if this PR is from a fork:
                     ```bash
                     gh pr view {{ .Input.body.issue.number }} --json headRepositoryOwner,baseRepository --jq '{head: .headRepositoryOwner.login, base: .baseRepository.owner.login}'
                     ```

                  2. **If same-repo PR** (head owner == base owner):
                     - Checkout the PR branch: `gh pr checkout {{ .Input.body.issue.number }}`
                     - Make the requested changes
                     - Commit with signoff: `git commit -s -m "fix: <description>"`
                     - Push the changes
                     - Reply confirming the changes were made

                  3. **If fork PR** (different owners):
                     - Reply explaining: "This PR is from a fork. I cannot directly push to fork PRs. Please make the changes locally, or a maintainer with write access to your fork can assist."
                  {{ else }}
                  This is an issue, not a PR. For code change requests on issues:
                  1. Clone the repository and create a new branch
                  2. Make the requested changes
                  3. Commit with signoff: `git commit -s -m "fix: <description>"`
                  4. Push the branch and create a PR, then enable auto-merge:
                     ```bash
                     git push -u origin <branch-name>
                     gh pr create --title "<title>" --body "<description>"
                     gh pr merge --auto --squash
                     ```
                  5. Reply with the PR link
                  {{ end }}
                  {{- end }}

                  ### Response Format

                  Always structure your response as:

                  ```
                  > [Quote the user's original comment]

                  @{{ .Input.body.comment.user.login }} [Your response here]
                  ```

                  ### Step 4: Post Your Response (REQUIRED)

                  After composing your response, you MUST post it as a GitHub comment:

                  {{- if .Input.body.discussion }}
                  ```bash
                  gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="<your response>"
                  ```
                  {{- else if .Input.body.pull_request }}
                  ```bash
                  gh pr comment {{ .Input.body.pull_request.number }} --body "<your response>"
                  ```
                  {{- else if .Input.body.issue }}
                  ```bash
                  gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "<your response>"
                  ```
                  {{- end }}

                  **IMPORTANT**: Do not just print the response to stdout. You MUST use the `gh` command to actually post the comment to GitHub.
              dest: spec.description

    # Rule 3: @kubeopencode-bot mention from non-privileged users (FIRST_TIME_CONTRIBUTOR, FIRST_TIMER, NONE)
    - template:
        name: comment-unprivileged
        conditions: comment-unprivileged-condition
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-comment-unprivileged-
                namespace: kubeopencode-system
              spec:
                agentRef: default
                description: ""
          parameters:
            - src:
                dependencyName: github-event
                dataTemplate: |
                  # @kubeopencode-bot Mention Handler (Non-Privileged User)

                  ## Event Details

                  - Repository: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}
                  {{- if .Input.body.issue }}
                  - Event Type: Issue/PR Comment
                  - Issue/PR #{{ .Input.body.issue.number }}: {{ .Input.body.issue.title }}
                  - Issue/PR URL: {{ .Input.body.issue.html_url }}
                  - Is PR: {{ if .Input.body.issue.pull_request }}Yes{{ else }}No{{ end }}
                  {{- else if .Input.body.pull_request }}
                  - Event Type: PR Review Comment
                  - PR #{{ .Input.body.pull_request.number }}: {{ .Input.body.pull_request.title }}
                  - PR URL: {{ .Input.body.pull_request.html_url }}
                  - Is PR: Yes
                  {{- else if .Input.body.discussion }}
                  - Event Type: Discussion Comment
                  - Discussion #{{ .Input.body.discussion.number }}: {{ .Input.body.discussion.title }}
                  - Discussion URL: {{ .Input.body.discussion.html_url }}
                  - Category: {{ .Input.body.discussion.category.name }}
                  {{- end }}

                  ## Comment Details

                  - Commenter: @{{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - Comment URL: {{ .Input.body.comment.html_url }}
                  {{- if .Input.body.pull_request }}
                  - File: {{ .Input.body.comment.path }}
                  - Line: {{ .Input.body.comment.line }}
                  {{- end }}

                  ### Comment Body

                  {{ .Input.body.comment.body }}

                  ## Instructions

                  You are @kubeopencode-bot responding to a mention from a **non-privileged user** ({{ .Input.body.comment.author_association }}).

                  ### Step 0: Gather Full Context (REQUIRED BEFORE RESPONDING)

                  Before analyzing the user's request, you MUST read the full context to understand the conversation history.

                  {{- if .Input.body.issue }}
                  **For Issue/PR Comments:**
                  1. Clone the repository first
                  2. Get the full issue/PR description and all previous comments:
                     ```bash
                     gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} view {{ .Input.body.issue.number }} --comments
                     ```
                  3. If this is a PR, checkout the PR branch to access the code locally:
                     ```bash
                     gh pr checkout {{ .Input.body.issue.number }}
                     ```
                  {{- else if .Input.body.pull_request }}
                  **For PR Review Comments:**
                  1. Clone the repository and checkout the PR:
                     ```bash
                     gh pr checkout {{ .Input.body.pull_request.number }}
                     ```
                  2. Get the full PR description and all issue-level comments:
                     ```bash
                     gh pr view {{ .Input.body.pull_request.number }} --comments
                     ```
                  3. Get all review comments on this PR:
                     ```bash
                     gh api repos/{{ .Input.body.repository.full_name }}/pulls/{{ .Input.body.pull_request.number }}/comments --jq '.[] | "[\(.user.login) on \(.path):\(.line)] \(.body)"'
                     ```
                  {{- else if .Input.body.discussion }}
                  **For Discussion Comments:**
                  1. Clone the repository first
                  2. Get the full discussion with all replies:
                     ```bash
                     gh api graphql -f query='
                       query {
                         repository(owner: "{{ .Input.body.repository.owner.login }}", name: "{{ .Input.body.repository.name }}") {
                           discussion(number: {{ .Input.body.discussion.number }}) {
                             title
                             body
                             comments(first: 100) {
                               nodes {
                                 author { login }
                                 body
                                 replies(first: 50) {
                                   nodes {
                                     author { login }
                                     body
                                   }
                                 }
                               }
                             }
                           }
                         }
                       }
                     '
                     ```
                  {{- end }}

                  **IMPORTANT**: Read and understand the full context before proceeding to Step 1. Your response should demonstrate awareness of the entire conversation, not just the triggering comment.

                  ### Step 1: Analyze Intent

                  Read the comment carefully and determine what the user is asking:
                  - **Question**: User is asking about the code or seeking help
                  - **Code Change Request**: User is EXPLICITLY asking you to modify code
                  - **No Clear Request**: User just mentioned @kubeopencode-bot without a specific question or request

                  **IMPORTANT**: If the comment only contains "@kubeopencode-bot" or a simple greeting without a clear ask, treat it as "No Clear Request". Do NOT assume the user wants code changes.

                  ### Step 2: For Questions

                  If the user is asking a question:
                  1. Clone the repository
                  {{- if .Input.body.discussion }}
                  2. Checkout the default branch
                  3. Read and analyze the relevant code
                  4. Reply with your answer using: `gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="..."`
                  {{- else if .Input.body.pull_request }}
                  2. Checkout the PR branch: `gh pr checkout {{ .Input.body.pull_request.number }}`
                  3. Read and analyze the relevant code (especially {{ .Input.body.comment.path }} around line {{ .Input.body.comment.line }})
                  4. Reply with your answer using: `gh pr comment {{ .Input.body.pull_request.number }} --body "..."`
                  {{- else if .Input.body.issue }}
                  2. {{ if .Input.body.issue.pull_request }}Checkout the PR branch: `gh pr checkout {{ .Input.body.issue.number }}`{{ else }}Checkout the default branch{{ end }}
                  3. Read and analyze the relevant code
                  4. Reply with your answer using: `gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "..."`
                  {{- end }}

                  ### Step 2b: For No Clear Request

                  If the user just mentioned you without a clear question or request:
                  1. Acknowledge the mention
                  2. Ask what they need help with
                  3. **DO NOT** make any code changes
                  {{- if .Input.body.discussion }}
                  4. Reply using: `gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="..."`
                  {{- else if .Input.body.pull_request }}
                  4. Reply using: `gh pr comment {{ .Input.body.pull_request.number }} --body "..."`
                  {{- else if .Input.body.issue }}
                  4. Reply using: `gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "..."`
                  {{- end }}

                  Example response:
                  ```
                  {{- if .Input.body.discussion }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me. How can I help you with this discussion?
                  {{- else if .Input.body.pull_request }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me in this PR review comment. How can I help you?
                  {{- else if .Input.body.issue }}
                  Hi @{{ .Input.body.comment.user.login }}! I noticed you mentioned me. How can I help you with this {{ if .Input.body.issue.pull_request }}PR{{ else }}issue{{ end }}?
                  {{- end }}

                  I can:
                  - Answer questions about the code
                  - Help explain how to implement changes

                  Just let me know what you'd like me to do!
                  ```

                  ### Step 3: For Code Change Requests

                  If the user is requesting code changes, politely decline:

                  Reply with something like:
                  ```
                  Thank you for your suggestion! Code change requests via @kubeopencode-bot are currently only available to repository maintainers, members, and contributors.

                  If you'd like to see this change implemented:
                  1. You can submit a Pull Request with the changes yourself
                  2. Open an issue describing the desired changes for a maintainer to review
                  3. Once you become a contributor (by having a PR merged), you'll be able to request code changes

                  I'm happy to answer questions about the codebase or help explain how to implement the change!
                  ```

                  ### Response Format

                  Always structure your response as:

                  ```
                  > [Quote the user's original comment]

                  @{{ .Input.body.comment.user.login }} [Your response here]
                  ```

                  ### Step 4: Post Your Response (REQUIRED)

                  After composing your response, you MUST post it as a GitHub comment:

                  {{- if .Input.body.discussion }}
                  ```bash
                  gh api repos/{{ .Input.body.repository.full_name }}/discussions/{{ .Input.body.discussion.number }}/comments -f body="<your response>"
                  ```
                  {{- else if .Input.body.pull_request }}
                  ```bash
                  gh pr comment {{ .Input.body.pull_request.number }} --body "<your response>"
                  ```
                  {{- else if .Input.body.issue }}
                  ```bash
                  gh {{ if .Input.body.issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .Input.body.issue.number }} --body "<your response>"
                  ```
                  {{- end }}

                  **IMPORTANT**: Do not just print the response to stdout. You MUST use the `gh` command to actually post the comment to GitHub.
              dest: spec.description

  # Conditions for filtering events
  # Note: Argo Events uses expr-lang expressions, not CEL
  # See: https://expr.medv.io/docs/Language-Definition
  conditions:
    # PR opened condition
    - name: pr-opened-condition
      expression: >-
        Input.headers["X-Github-Event"] == "pull_request" &&
        Input.body.action == "opened"

    # Comment from privileged users
    # Note: expr-lang uses 'in' operator differently - we need to check each value
    - name: comment-privileged-condition
      expression: >-
        (Input.headers["X-Github-Event"] == "issue_comment" ||
         Input.headers["X-Github-Event"] == "pull_request_review_comment" ||
         Input.headers["X-Github-Event"] == "discussion_comment") &&
        Input.body.action == "created" &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "OWNER" ||
         Input.body.comment.author_association == "MEMBER" ||
         Input.body.comment.author_association == "CONTRIBUTOR" ||
         Input.body.comment.author_association == "COLLABORATOR")

    # Comment from non-privileged users
    - name: comment-unprivileged-condition
      expression: >-
        (Input.headers["X-Github-Event"] == "issue_comment" ||
         Input.headers["X-Github-Event"] == "pull_request_review_comment" ||
         Input.headers["X-Github-Event"] == "discussion_comment") &&
        Input.body.action == "created" &&
        contains(Input.body.comment.body, "@kubeopencode-bot") &&
        Input.body.comment.user.type != "Bot" &&
        (Input.body.comment.author_association == "FIRST_TIME_CONTRIBUTOR" ||
         Input.body.comment.author_association == "FIRST_TIMER" ||
         Input.body.comment.author_association == "NONE")
