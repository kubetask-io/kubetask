# ClusterWorkflowTemplate: Code Agent with OpenCode CLI
#
# A cluster-scoped workflow template that can be used by any team/namespace.
# Each namespace needs to provide its own:
#   - ServiceAccount 'argo-workflow' with ConfigMap read permissions
#   - Secret 'ai-api-keys' with 'GEMINI_API_KEY'
#   - Optional: Context ConfigMaps for aggregation
#
# Usage:
#   # Submit a workflow from any namespace
#   argo submit --from clusterworkflowtemplate/code-agent-opencode -n <namespace>
#
#   # With custom task
#   argo submit --from clusterworkflowtemplate/code-agent-opencode -n server-foundation \
#     -p task="Analyze this codebase"
#
#   # With GitHub repo and context ConfigMaps
#   argo submit --from clusterworkflowtemplate/code-agent-opencode -n server-foundation \
#     -p repo="https://github.com/stolostron/multicluster-global-hub" \
#     -p branch="main" \
#     -p context-configmaps="coding-standards,project-context" \
#     -p task="Review the code for security issues"

apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: code-agent-opencode
  labels:
    app: code-agent
    agent-provider: opencode
spec:
  entrypoint: opencode-task
  serviceAccountName: argo-workflow
  # Pod garbage collection: delete completed pods after 30 minutes
  podGC:
    strategy: OnPodCompletion
    deleteDelayDuration: 30m
  # Workflow timeout: 4 hours (14400 seconds)
  activeDeadlineSeconds: 14400
  # TTL strategy for automatic workflow cleanup
  ttlStrategy:
    secondsAfterSuccess: 259200   # 3 days
    secondsAfterFailure: 604800   # 1 week
  # Workflow-level arguments (can be overridden at submission)
  arguments:
    parameters:
    - name: task
      value: "Say hi and introduce yourself briefly"
    # Context aggregation: comma-separated ConfigMap list
    # Format: "cm1,cm2,cm3" or "cm1:key1,cm2" (specify key)
    - name: context-configmaps
      value: ""
    - name: repo
      value: ""
    - name: branch
      value: "main"
    # Container image parameters
    - name: image
      value: "quay.io/zhaoxue/code-agent:latest"
    - name: imagePullPolicy
      value: "IfNotPresent"
    # Runtime class for container isolation (e.g., "gvisor" for enhanced isolation)
    # Leave empty to use default runtime (runc)
    - name: agent-runtimeclass
      value: ""
  templates:
  - name: opencode-task
    # Retry only on transient infrastructure errors (e.g., ImagePullBackOff, node failures)
    # Do not retry on agent task failures since AI results are not idempotent
    retryStrategy:
      limit: 2
      retryPolicy: "OnTransientError"
    inputs:
      parameters:
      - name: task
        value: "{{workflow.parameters.task}}"
      - name: image
        value: "{{workflow.parameters.image}}"
      - name: imagePullPolicy
        value: "{{workflow.parameters.imagePullPolicy}}"
      - name: repo
        value: "{{workflow.parameters.repo}}"
      - name: branch
        value: "{{workflow.parameters.branch}}"
      # Context aggregation
      - name: context-configmaps
        value: "{{workflow.parameters.context-configmaps}}"
      - name: agent-runtimeclass
        value: "{{workflow.parameters.agent-runtimeclass}}"
      artifacts:
      - name: source
        path: /workspace
        optional: true
        git:
          repo: "{{inputs.parameters.repo}}"
          branch: "{{inputs.parameters.branch}}"
          depth: 1
    # Runtime class for container isolation (configurable via parameter)
    # Empty value uses default runtime (runc), "gvisor" for enhanced isolation
    runtimeClassName: "{{inputs.parameters.agent-runtimeclass}}"
    # Output parameters created by the AI agent
    # The agent should be instructed via context ConfigMaps to create these files
    outputs:
      parameters:
      - name: result
        valueFrom:
          path: /outputs/result.json
          default: "{}"
      - name: summary
        valueFrom:
          path: /outputs/summary.md
          default: ""
    # Let OpenShift assign UID from the project's allowed range
    securityContext:
      runAsNonRoot: true
    # Shared volume for outputs (ensures outputs are accessible to wait container)
    # Note: /workspace is managed by Argo's git artifact when present
    volumes:
    - name: outputs
      emptyDir: {}
    container:
      volumeMounts:
      - name: outputs
        mountPath: /outputs
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
      image: "{{inputs.parameters.image}}"
      imagePullPolicy: "{{inputs.parameters.imagePullPolicy}}"
      workingDir: /workspace
      command: ["sh", "-c"]
      args:
        - |
          echo "Starting OpenCode CLI task..."
          echo "Running as user: $(id)"

          # Ensure /workspace directory exists (for steps without git artifact)
          mkdir -p /workspace

          # Pre-configure OpenCode settings
          # - model: Main model for code generation tasks
          # - small_model: Lightweight model for title generation (must support thinking mode)
          # Note: Using Gemini 2.5 due to OpenCode compatibility issues with Gemini 3
          # See: https://github.com/sst/opencode/issues/4832
          mkdir -p ~/.config/opencode
          cat > ~/.config/opencode/opencode.json << 'OPENCODE_CONFIG'
          {
            "$schema": "https://opencode.ai/config.json",
            "model": "google/gemini-2.5-pro",
            "small_model": "google/gemini-2.5-flash"
          }
          OPENCODE_CONFIG
          echo "OpenCode configured: model=gemini-2.5-pro, small_model=gemini-2.5-flash"

          # Configure global gitignore to exclude CONTEXTS.md
          echo "CONTEXTS.md" >> ~/.gitignore_global
          git config --global core.excludesFile ~/.gitignore_global

          if [ -d "/workspace/.git" ]; then
            echo "Repository cloned to /workspace"
            echo "Repo: {{inputs.parameters.repo}}"
            echo "Branch: {{inputs.parameters.branch}}"
            ls -la /workspace
          fi

          # Context Aggregation: use external script to fetch ConfigMap contexts
          context-aggregator.sh \
            -c "{{inputs.parameters.context-configmaps}}" \
            -o /workspace/CONTEXTS.md

          # Write task to file using heredoc (prevents shell interpretation issues)
          cat > /tmp/task.txt <<'TASK_EOF'
          {{inputs.parameters.task}}
          TASK_EOF

          echo "Running task from file..."
          # Combine context and task, then pipe to opencode
          (
            cat /workspace/CONTEXTS.md
            echo ""
            echo "# Task"
            cat /tmp/task.txt
          ) | opencode run --format json | opencode-stream-json-reader.sh

          # Copy outputs to shared volume for wait container
          # /outputs is an emptyDir shared with wait container
          # /workspace may be ephemeral when no git artifact is present
          echo "Copying outputs to shared volume..."
          cp /workspace/result.json /outputs/result.json 2>/dev/null || echo '{}' > /outputs/result.json
          cp /workspace/summary.md /outputs/summary.md 2>/dev/null || echo '' > /outputs/summary.md
          echo "Task completed."
      env:
      - name: GOOGLE_GENERATIVE_AI_API_KEY
        valueFrom:
          secretKeyRef:
            name: ai-api-keys
            key: GEMINI_API_KEY
      resources:
        requests:
          memory: "1Gi"
          cpu: "250m"
        limits:
          memory: "4Gi"
          cpu: "1000m"
