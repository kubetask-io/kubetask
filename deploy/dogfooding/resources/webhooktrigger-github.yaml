apiVersion: kubetask.io/v1alpha1
kind: WebhookTrigger
metadata:
  name: github
spec:
  auth:
    hmac:
      secretRef:
        name: github-webhook-secret
        key: hmacKey
      signatureHeader: X-Hub-Signature-256
      algorithm: sha256
  matchPolicy: First
  rules:
    # Rule 1: PR opened - auto review
    - name: pr-opened
      filter: |
        headers["x-github-event"] == "pull_request" &&
        body.action == "opened"
      resourceTemplate:
        task:
          agentRef: default
          description: |
            Review this Pull Request and post your review as a comment:

            Repository: {{ .repository.full_name }}
            Author: {{ .sender.login }}

            PR #{{ .pull_request.number }}: {{ .pull_request.title }}
            PR URL: {{ .pull_request.html_url }}
            PR Body: {{ .pull_request.body }}

            ## Instructions

            1. Clone the repository and checkout the PR branch
            2. Review the code changes thoroughly
            3. Prepare a constructive review with:
               - Summary of changes
               - Code quality observations
               - Suggestions for improvement (if any)
               - Overall assessment
            4. Post your review as a PR comment.

    # Rule 2: @kubetask-bot mention from privileged users (OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR)
    # Supports: issue_comment, pull_request_review_comment, discussion_comment
    - name: comment-privileged
      filter: |
        headers["x-github-event"] in ["issue_comment", "pull_request_review_comment", "discussion_comment"] &&
        body.action == "created" &&
        body.comment.body.contains("@kubetask-bot") &&
        body.comment.author_association in ["OWNER", "MEMBER", "CONTRIBUTOR", "COLLABORATOR"]
      resourceTemplate:
        task:
          agentRef: default
          description: |
            # @kubetask-bot Mention Handler (Privileged User)

            ## Event Details

            - Repository: {{ .repository.full_name }}
            - Clone URL: {{ .repository.clone_url }}
            {{- if .issue }}
            - Event Type: Issue/PR Comment
            - Issue/PR #{{ .issue.number }}: {{ .issue.title }}
            - Issue/PR URL: {{ .issue.html_url }}
            - Is PR: {{ if .issue.pull_request }}Yes{{ else }}No{{ end }}
            {{- else if .pull_request }}
            - Event Type: PR Review Comment
            - PR #{{ .pull_request.number }}: {{ .pull_request.title }}
            - PR URL: {{ .pull_request.html_url }}
            - Is PR: Yes
            {{- else if .discussion }}
            - Event Type: Discussion Comment
            - Discussion #{{ .discussion.number }}: {{ .discussion.title }}
            - Discussion URL: {{ .discussion.html_url }}
            - Category: {{ .discussion.category.name }}
            {{- end }}

            ## Comment Details

            - Commenter: @{{ .comment.user.login }}
            - Author Association: {{ .comment.author_association }}
            - Comment URL: {{ .comment.html_url }}
            {{- if .pull_request }}
            - File: {{ .comment.path }}
            - Line: {{ .comment.line }}
            {{- end }}

            ### Comment Body

            {{ .comment.body }}

            ## Instructions

            You are @kubetask-bot responding to a mention from a **privileged user** ({{ .comment.author_association }}).

            ### Step 0: Gather Full Context (REQUIRED BEFORE RESPONDING)

            Before analyzing the user's request, you MUST read the full context to understand the conversation history.

            {{- if .issue }}
            **For Issue/PR Comments:**
            1. Clone the repository first
            2. Get the full issue/PR description and all previous comments:
               ```bash
               gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} view {{ .issue.number }} --comments
               ```
            3. If this is a PR, checkout the PR branch to access the code locally:
               ```bash
               gh pr checkout {{ .issue.number }}
               ```
            {{- else if .pull_request }}
            **For PR Review Comments:**
            1. Clone the repository and checkout the PR:
               ```bash
               gh pr checkout {{ .pull_request.number }}
               ```
            2. Get the full PR description and all issue-level comments:
               ```bash
               gh pr view {{ .pull_request.number }} --comments
               ```
            3. Get all review comments on this PR:
               ```bash
               gh api repos/{{ .repository.full_name }}/pulls/{{ .pull_request.number }}/comments --jq '.[] | "[\(.user.login) on \(.path):\(.line)] \(.body)"'
               ```
            {{- else if .discussion }}
            **For Discussion Comments:**
            1. Clone the repository first
            2. Get the full discussion with all replies:
               ```bash
               gh api graphql -f query='
                 query {
                   repository(owner: "{{ .repository.owner.login }}", name: "{{ .repository.name }}") {
                     discussion(number: {{ .discussion.number }}) {
                       title
                       body
                       comments(first: 100) {
                         nodes {
                           author { login }
                           body
                           replies(first: 50) {
                             nodes {
                               author { login }
                               body
                             }
                           }
                         }
                       }
                     }
                   }
                 }
               '
               ```
            {{- end }}

            **IMPORTANT**: Read and understand the full context before proceeding to Step 1. Your response should demonstrate awareness of the entire conversation, not just the triggering comment.

            ### Step 1: Analyze Intent

            Read the comment carefully and determine what the user is asking:
            - **Question**: User is asking about the code, seeking explanation, or asking for help
            - **Code Change Request**: User is EXPLICITLY asking you to modify, fix, add, update, or remove code (must contain clear action words like "please fix", "can you update", "add X to Y", etc.)
            - **No Clear Request**: User just mentioned @kubetask-bot without a specific question or request

            **IMPORTANT**: If the comment only contains "@kubetask-bot" or a simple greeting without a clear ask, treat it as "No Clear Request". Do NOT assume the user wants code changes.

            ### Step 2: For Questions

            If the user is asking a question:
            1. Clone the repository
            {{- if .discussion }}
            2. Checkout the default branch
            3. Read and analyze the relevant code
            4. Reply with your answer using: `gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="..."`
            {{- else if .pull_request }}
            2. Checkout the PR branch: `gh pr checkout {{ .pull_request.number }}`
            3. Read and analyze the relevant code (especially {{ .comment.path }} around line {{ .comment.line }})
            4. Reply with your answer using: `gh pr comment {{ .pull_request.number }} --body "..."`
            {{- else if .issue }}
            2. {{ if .issue.pull_request }}Checkout the PR branch: `gh pr checkout {{ .issue.number }}`{{ else }}Checkout the default branch{{ end }}
            3. Read and analyze the relevant code
            4. Reply with your answer using: `gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "..."`
            {{- end }}

            ### Step 2b: For No Clear Request

            If the user just mentioned you without a clear question or request:
            1. Acknowledge the mention
            2. Ask what they need help with
            3. **DO NOT** make any code changes
            {{- if .discussion }}
            4. Reply using: `gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="..."`
            {{- else if .pull_request }}
            4. Reply using: `gh pr comment {{ .pull_request.number }} --body "..."`
            {{- else if .issue }}
            4. Reply using: `gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "..."`
            {{- end }}

            Example response:
            ```
            {{- if .discussion }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me. How can I help you with this discussion?
            {{- else if .pull_request }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me in this PR review comment. How can I help you?
            {{- else if .issue }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me. How can I help you with this {{ if .issue.pull_request }}PR{{ else }}issue{{ end }}?
            {{- end }}

            I can:
            - Answer questions about the code
            - Review changes
            - Make code modifications (if you describe what you need)

            Just let me know what you'd like me to do!
            ```

            ### Step 3: For Code Change Requests

            **ONLY proceed with code changes if the user EXPLICITLY requested them.** Look for clear action words like:
            - "please fix...", "can you update...", "add X to...", "remove...", "change..."

            If you're unsure whether the user wants code changes, ask for clarification first.

            {{- if .discussion }}
            This is a discussion comment. For code change requests in discussions:
            - Reply explaining that code changes should be made via a Pull Request
            - Offer to help create a PR if the user describes what changes they want
            {{- else if .pull_request }}
            If the user is requesting code changes on this PR review comment:

            1. First, check if this PR is from a fork:
               ```bash
               gh pr view {{ .pull_request.number }} --json headRepositoryOwner,baseRepository --jq '{head: .headRepositoryOwner.login, base: .baseRepository.owner.login}'
               ```

            2. **If same-repo PR** (head owner == base owner):
               - Checkout the PR branch: `gh pr checkout {{ .pull_request.number }}`
               - Make the requested changes (especially in {{ .comment.path }} around line {{ .comment.line }})
               - Commit with signoff: `git commit -s -m "fix: <description>"`
               - Push the changes
               - Reply confirming the changes were made

            3. **If fork PR** (different owners):
               - Reply explaining: "This PR is from a fork. I cannot directly push to fork PRs. Please make the changes locally, or a maintainer with write access to your fork can assist."
            {{- else if .issue }}
            {{ if .issue.pull_request }}
            If the user is requesting code changes on this PR:

            1. First, check if this PR is from a fork:
               ```bash
               gh pr view {{ .issue.number }} --json headRepositoryOwner,baseRepository --jq '{head: .headRepositoryOwner.login, base: .baseRepository.owner.login}'
               ```

            2. **If same-repo PR** (head owner == base owner):
               - Checkout the PR branch: `gh pr checkout {{ .issue.number }}`
               - Make the requested changes
               - Commit with signoff: `git commit -s -m "fix: <description>"`
               - Push the changes
               - Reply confirming the changes were made

            3. **If fork PR** (different owners):
               - Reply explaining: "This PR is from a fork. I cannot directly push to fork PRs. Please make the changes locally, or a maintainer with write access to your fork can assist."
            {{ else }}
            This is an issue, not a PR. For code change requests on issues:
            - Reply explaining that code changes should be made via a Pull Request
            - Offer to help create a PR if the user describes what changes they want
            {{ end }}
            {{- end }}

            ### Response Format

            Always structure your response as:

            ```
            > [Quote the user's original comment]

            @{{ .comment.user.login }} [Your response here]
            ```

            ### Step 4: Post Your Response (REQUIRED)

            After composing your response, you MUST post it as a GitHub comment:

            {{- if .discussion }}
            ```bash
            gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="<your response>"
            ```
            {{- else if .pull_request }}
            ```bash
            gh pr comment {{ .pull_request.number }} --body "<your response>"
            ```
            {{- else if .issue }}
            ```bash
            gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "<your response>"
            ```
            {{- end }}

            **IMPORTANT**: Do not just print the response to stdout. You MUST use the `gh` command to actually post the comment to GitHub.

    # Rule 3: @kubetask-bot mention from non-privileged users (FIRST_TIME_CONTRIBUTOR, FIRST_TIMER, NONE)
    # Supports: issue_comment, pull_request_review_comment, discussion_comment
    - name: comment-unprivileged
      filter: |
        headers["x-github-event"] in ["issue_comment", "pull_request_review_comment", "discussion_comment"] &&
        body.action == "created" &&
        body.comment.body.contains("@kubetask-bot") &&
        body.comment.author_association in ["FIRST_TIME_CONTRIBUTOR", "FIRST_TIMER", "NONE"]
      resourceTemplate:
        task:
          agentRef: default
          description: |
            # @kubetask-bot Mention Handler (Non-Privileged User)

            ## Event Details

            - Repository: {{ .repository.full_name }}
            - Clone URL: {{ .repository.clone_url }}
            {{- if .issue }}
            - Event Type: Issue/PR Comment
            - Issue/PR #{{ .issue.number }}: {{ .issue.title }}
            - Issue/PR URL: {{ .issue.html_url }}
            - Is PR: {{ if .issue.pull_request }}Yes{{ else }}No{{ end }}
            {{- else if .pull_request }}
            - Event Type: PR Review Comment
            - PR #{{ .pull_request.number }}: {{ .pull_request.title }}
            - PR URL: {{ .pull_request.html_url }}
            - Is PR: Yes
            {{- else if .discussion }}
            - Event Type: Discussion Comment
            - Discussion #{{ .discussion.number }}: {{ .discussion.title }}
            - Discussion URL: {{ .discussion.html_url }}
            - Category: {{ .discussion.category.name }}
            {{- end }}

            ## Comment Details

            - Commenter: @{{ .comment.user.login }}
            - Author Association: {{ .comment.author_association }}
            - Comment URL: {{ .comment.html_url }}
            {{- if .pull_request }}
            - File: {{ .comment.path }}
            - Line: {{ .comment.line }}
            {{- end }}

            ### Comment Body

            {{ .comment.body }}

            ## Instructions

            You are @kubetask-bot responding to a mention from a **non-privileged user** ({{ .comment.author_association }}).

            ### Step 0: Gather Full Context (REQUIRED BEFORE RESPONDING)

            Before analyzing the user's request, you MUST read the full context to understand the conversation history.

            {{- if .issue }}
            **For Issue/PR Comments:**
            1. Clone the repository first
            2. Get the full issue/PR description and all previous comments:
               ```bash
               gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} view {{ .issue.number }} --comments
               ```
            3. If this is a PR, checkout the PR branch to access the code locally:
               ```bash
               gh pr checkout {{ .issue.number }}
               ```
            {{- else if .pull_request }}
            **For PR Review Comments:**
            1. Clone the repository and checkout the PR:
               ```bash
               gh pr checkout {{ .pull_request.number }}
               ```
            2. Get the full PR description and all issue-level comments:
               ```bash
               gh pr view {{ .pull_request.number }} --comments
               ```
            3. Get all review comments on this PR:
               ```bash
               gh api repos/{{ .repository.full_name }}/pulls/{{ .pull_request.number }}/comments --jq '.[] | "[\(.user.login) on \(.path):\(.line)] \(.body)"'
               ```
            {{- else if .discussion }}
            **For Discussion Comments:**
            1. Clone the repository first
            2. Get the full discussion with all replies:
               ```bash
               gh api graphql -f query='
                 query {
                   repository(owner: "{{ .repository.owner.login }}", name: "{{ .repository.name }}") {
                     discussion(number: {{ .discussion.number }}) {
                       title
                       body
                       comments(first: 100) {
                         nodes {
                           author { login }
                           body
                           replies(first: 50) {
                             nodes {
                               author { login }
                               body
                             }
                           }
                         }
                       }
                     }
                   }
                 }
               '
               ```
            {{- end }}

            **IMPORTANT**: Read and understand the full context before proceeding to Step 1. Your response should demonstrate awareness of the entire conversation, not just the triggering comment.

            ### Step 1: Analyze Intent

            Read the comment carefully and determine what the user is asking:
            - **Question**: User is asking about the code or seeking help
            - **Code Change Request**: User is EXPLICITLY asking you to modify code
            - **No Clear Request**: User just mentioned @kubetask-bot without a specific question or request

            **IMPORTANT**: If the comment only contains "@kubetask-bot" or a simple greeting without a clear ask, treat it as "No Clear Request". Do NOT assume the user wants code changes.

            ### Step 2: For Questions

            If the user is asking a question:
            1. Clone the repository
            {{- if .discussion }}
            2. Checkout the default branch
            3. Read and analyze the relevant code
            4. Reply with your answer using: `gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="..."`
            {{- else if .pull_request }}
            2. Checkout the PR branch: `gh pr checkout {{ .pull_request.number }}`
            3. Read and analyze the relevant code (especially {{ .comment.path }} around line {{ .comment.line }})
            4. Reply with your answer using: `gh pr comment {{ .pull_request.number }} --body "..."`
            {{- else if .issue }}
            2. {{ if .issue.pull_request }}Checkout the PR branch: `gh pr checkout {{ .issue.number }}`{{ else }}Checkout the default branch{{ end }}
            3. Read and analyze the relevant code
            4. Reply with your answer using: `gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "..."`
            {{- end }}

            ### Step 2b: For No Clear Request

            If the user just mentioned you without a clear question or request:
            1. Acknowledge the mention
            2. Ask what they need help with
            3. **DO NOT** make any code changes
            {{- if .discussion }}
            4. Reply using: `gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="..."`
            {{- else if .pull_request }}
            4. Reply using: `gh pr comment {{ .pull_request.number }} --body "..."`
            {{- else if .issue }}
            4. Reply using: `gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "..."`
            {{- end }}

            Example response:
            ```
            {{- if .discussion }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me. How can I help you with this discussion?
            {{- else if .pull_request }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me in this PR review comment. How can I help you?
            {{- else if .issue }}
            Hi @{{ .comment.user.login }}! I noticed you mentioned me. How can I help you with this {{ if .issue.pull_request }}PR{{ else }}issue{{ end }}?
            {{- end }}

            I can:
            - Answer questions about the code
            - Help explain how to implement changes

            Just let me know what you'd like me to do!
            ```

            ### Step 3: For Code Change Requests

            If the user is requesting code changes, politely decline:

            Reply with something like:
            ```
            Thank you for your suggestion! Code change requests via @kubetask-bot are currently only available to repository maintainers, members, and contributors.

            If you'd like to see this change implemented:
            1. You can submit a Pull Request with the changes yourself
            2. Open an issue describing the desired changes for a maintainer to review
            3. Once you become a contributor (by having a PR merged), you'll be able to request code changes

            I'm happy to answer questions about the codebase or help explain how to implement the change!
            ```

            ### Response Format

            Always structure your response as:

            ```
            > [Quote the user's original comment]

            @{{ .comment.user.login }} [Your response here]
            ```

            ### Step 4: Post Your Response (REQUIRED)

            After composing your response, you MUST post it as a GitHub comment:

            {{- if .discussion }}
            ```bash
            gh api repos/{{ .repository.full_name }}/discussions/{{ .discussion.number }}/comments -f body="<your response>"
            ```
            {{- else if .pull_request }}
            ```bash
            gh pr comment {{ .pull_request.number }} --body "<your response>"
            ```
            {{- else if .issue }}
            ```bash
            gh {{ if .issue.pull_request }}pr{{ else }}issue{{ end }} comment {{ .issue.number }} --body "<your response>"
            ```
            {{- end }}

            **IMPORTANT**: Do not just print the response to stdout. You MUST use the `gh` command to actually post the comment to GitHub.
