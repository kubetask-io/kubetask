# Copyright Contributors to the KubeTask project
# Workflow to check and update Go version
apiVersion: kubetask.io/v1alpha1
kind: Workflow
metadata:
  name: go-version-update
spec:
  stages:
    - name: update-go
      tasks:
        - name: check-and-update
          contexts:
          - inline:
            type: Git
            mountPath: kubetask
            git:
              repository: https://github.com/kubetask-io/kubetask
              ref: main
          description: |
            Check the latest stable version of Go and automatically update the current project if a new version is available.

            Task Steps:
            1. Fetch the latest stable Go version from https://go.dev/dl/?mode=json
            2. Check the current Go version in the project's go.mod file
            3. If a new stable version is available (e.g., 1.25 -> 1.26), perform the following:
               - Create a new branch `chore/update-go-<new-version>`
               - Update the Go version in go.mod
               - Run `go mod tidy` to ensure dependencies are correct
               - Run tests to ensure the update does not break existing functionality
               - Commit changes and create a PR
            4. Update the Go version in Dockerfile
            5. Update the Go version in all files under .github/workflows

            Notes:
            - Only focus on minor version updates (e.g., 1.25 -> 1.26), ignore patch version updates (e.g., 1.25.1 -> 1.25.2)
            - If tests fail, do not create a PR; instead, log the failure reason
            - PR title format: `chore: update Go version to <new-version>`

            Target repository: kubetask-io/kubetask
