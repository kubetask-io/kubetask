---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.5
  name: webhooktriggers.kubetask.io
spec:
  group: kubetask.io
  names:
    kind: WebhookTrigger
    listKind: WebhookTriggerList
    plural: webhooktriggers
    shortNames:
    - wht
    singular: webhooktrigger
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.totalTriggered
      name: Triggered
      type: integer
    - jsonPath: .status.lastTriggeredTime
      name: Last Trigger
      type: date
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: "WebhookTrigger represents a webhook-to-Task mapping rule.\nWhen
          the webhook endpoint receives a request that matches the configured filters,\nit
          creates a Task based on the taskTemplate.\n\nEach WebhookTrigger has a unique
          endpoint at:\n\n\t/webhooks/<namespace>/<trigger-name>\n\nWebhookTrigger
          is platform-agnostic and supports any webhook source\n(GitHub, GitLab, custom
          systems, etc.) through configurable authentication\nand filtering."
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: Spec defines the desired state of WebhookTrigger
            properties:
              auth:
                description: |-
                  Auth defines authentication for webhook validation.
                  If not specified, webhooks are accepted without authentication.
                  Authentication is applied at the trigger level (before rule evaluation).
                properties:
                  bearerToken:
                    description: BearerToken configures Bearer token validation from
                      Authorization header.
                    properties:
                      secretRef:
                        description: SecretRef references a Secret containing the
                          expected token.
                        properties:
                          key:
                            description: Key of the Secret to select.
                            type: string
                          name:
                            description: Name of the Secret.
                            type: string
                        required:
                        - key
                        - name
                        type: object
                    required:
                    - secretRef
                    type: object
                  header:
                    description: |-
                      Header configures simple header value matching.
                      Common for GitLab (X-Gitlab-Token) and custom webhooks.
                    properties:
                      name:
                        description: |-
                          Name is the HTTP header name to check.
                          Example: "X-Gitlab-Token", "X-Custom-Auth"
                        type: string
                      secretRef:
                        description: SecretRef references a Secret containing the
                          expected header value.
                        properties:
                          key:
                            description: Key of the Secret to select.
                            type: string
                          name:
                            description: Name of the Secret.
                            type: string
                        required:
                        - key
                        - name
                        type: object
                    required:
                    - name
                    - secretRef
                    type: object
                  hmac:
                    description: |-
                      HMAC configures HMAC signature validation.
                      Common for GitHub (X-Hub-Signature-256) and similar platforms.
                    properties:
                      algorithm:
                        default: sha256
                        description: Algorithm specifies the HMAC algorithm to use.
                        enum:
                        - sha1
                        - sha256
                        - sha512
                        type: string
                      secretRef:
                        description: SecretRef references a Secret containing the
                          HMAC secret key.
                        properties:
                          key:
                            description: Key of the Secret to select.
                            type: string
                          name:
                            description: Name of the Secret.
                            type: string
                        required:
                        - key
                        - name
                        type: object
                      signatureHeader:
                        description: |-
                          SignatureHeader is the HTTP header name containing the signature.
                          Example: "X-Hub-Signature-256" for GitHub, "X-Signature" for custom systems.
                        type: string
                    required:
                    - secretRef
                    - signatureHeader
                    type: object
                type: object
              concurrencyPolicy:
                allOf:
                - enum:
                  - Allow
                  - Forbid
                  - Replace
                - enum:
                  - Allow
                  - Forbid
                  - Replace
                default: Allow
                description: |-
                  ConcurrencyPolicy specifies how to treat concurrent resources triggered by this webhook.
                  This is the default policy applied at the trigger level.
                  Individual rules can override this with their own concurrencyPolicy.

                  - Allow: Create a new resource regardless of existing running resources (default)
                  - Forbid: Skip this webhook if there's already a running resource
                  - Replace: Stop the running resource and create a new one
                type: string
              filter:
                description: |-
                  Filter is a CEL expression that must evaluate to true for the webhook to trigger.
                  If not specified, all webhooks are accepted.

                  DEPRECATED: Use Rules[].filter instead for multiple filters.
                  This field is kept for backward compatibility with simple single-rule triggers.
                  Mutually exclusive with Rules.

                  The webhook payload is available as the variable "body".
                  HTTP headers are available as the variable "headers" (map[string]string, lowercase keys).

                  CEL provides powerful filtering capabilities:
                    - Field access: body.action, body.repository.full_name
                    - Comparisons: body.action == "opened", body.pull_request.additions < 500
                    - List operations: body.action in ["opened", "synchronize"]
                    - String functions: body.title.startsWith("[WIP]"), body.branch.matches("^feature/.*")
                    - Existence checks: has(body.pull_request) && body.pull_request.draft == false
                    - List predicates: body.labels.exists(l, l.name == "needs-review")

                  Examples:
                    # Simple equality
                    filter: 'body.action == "opened"'

                    # Multiple conditions
                    filter: 'body.action in ["opened", "synchronize"] && body.repository.full_name == "myorg/myrepo"'

                    # Complex logic
                    filter: |
                      !body.pull_request.title.startsWith("[WIP]") &&
                      body.pull_request.additions + body.pull_request.deletions < 500 &&
                      body.pull_request.labels.exists(l, l.name == "needs-review")
                type: string
              matchPolicy:
                allOf:
                - enum:
                  - First
                  - All
                - enum:
                  - First
                  - All
                default: First
                description: |-
                  MatchPolicy specifies how matching rules are selected.
                  - First: Only trigger the first matching rule (default)
                  - All: Trigger all matching rules, creating multiple resources

                  This field is only relevant when Rules is specified.
                type: string
              resourceTemplate:
                description: |-
                  ResourceTemplate defines what resource to create when a webhook matches.
                  Supports Task, WorkflowRun (inline), or WorkflowRef.
                  This replaces TaskTemplate for new code and allows triggering Workflows.
                  Mutually exclusive with Rules and TaskTemplate.
                properties:
                  task:
                    description: |-
                      Task defines a Task to create.
                      Use this for simple single-stage task execution.
                      Mutually exclusive with WorkflowRun and WorkflowRef.
                    properties:
                      agentRef:
                        description: |-
                          AgentRef references an Agent for task execution.
                          If not specified, uses the "default" Agent in the same namespace.
                        type: string
                      contexts:
                        description: Contexts provides additional context for the
                          task.
                        items:
                          description: |-
                            ContextItem defines context with content and mount path.
                            Used directly in Task/Agent specs to provide additional context for task execution.
                          properties:
                            configMap:
                              description: ConfigMap context (required when Type ==
                                "ConfigMap")
                              properties:
                                key:
                                  description: |-
                                    Key specifies a single key to mount as a file.
                                    If not specified, all keys are mounted as files in the directory.
                                  type: string
                                name:
                                  description: Name of the ConfigMap
                                  type: string
                                optional:
                                  description: Optional specifies whether the ConfigMap
                                    must exist.
                                  type: boolean
                              required:
                              - name
                              type: object
                            fileMode:
                              description: |-
                                FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                                Only applicable when MountPath is specified.
                                If not specified, defaults to 0644.
                              format: int32
                              type: integer
                            git:
                              description: Git context (required when Type == "Git")
                              properties:
                                depth:
                                  default: 1
                                  description: |-
                                    Depth specifies the clone depth for shallow cloning.
                                    1 means shallow clone (fastest), 0 means full clone.
                                    Defaults to 1 for efficiency.
                                  type: integer
                                path:
                                  description: |-
                                    Path is the path within the repository to mount.
                                    Can be a file or directory. If empty, the entire repository is mounted.

                                    Note on .git directory:
                                      - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                      - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                    Example: ".claude/", "docs/guide.md"
                                  type: string
                                ref:
                                  default: HEAD
                                  description: |-
                                    Ref is the Git reference (branch, tag, or commit SHA).
                                    Defaults to "HEAD" if not specified.
                                  type: string
                                repository:
                                  description: |-
                                    Repository is the Git repository URL.
                                    Example: "https://github.com/org/contexts"
                                  type: string
                                secretRef:
                                  description: |-
                                    SecretRef references a Secret containing Git credentials.
                                    The Secret should contain one of:
                                      - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                      - "ssh-privatekey": For SSH key-based auth
                                    If not specified, anonymous clone is attempted.
                                  properties:
                                    name:
                                      description: Name of the Secret containing Git
                                        credentials.
                                      type: string
                                  required:
                                  - name
                                  type: object
                              required:
                              - repository
                              type: object
                            mountPath:
                              description: |-
                                MountPath specifies where this context should be mounted in the agent pod.

                                Path resolution follows Tekton conventions:
                                - Absolute paths (starting with "/") are used as-is
                                - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                                See ContextRef.MountPath for detailed examples.

                                Note: For Runtime context type, MountPath is ignored - content is always
                                appended to task.md.
                              type: string
                            runtime:
                              description: |-
                                Runtime context (optional when Type == "Runtime")
                                Enables KubeTask platform awareness. The controller injects a system prompt
                                that explains the runtime environment to the agent.
                              type: object
                            text:
                              description: |-
                                Text is the text content (required when Type == "Text").
                                Contains text content defined directly in YAML.
                              type: string
                            type:
                              description: 'Type of context source: Text, ConfigMap,
                                Git, or Runtime'
                              enum:
                              - Text
                              - ConfigMap
                              - Git
                              - Runtime
                              type: string
                          required:
                          - type
                          type: object
                        type: array
                      description:
                        description: |-
                          Description is the task instruction/prompt.
                          Supports Go template syntax with webhook payload data.

                          Available template data:
                            - The entire webhook JSON payload is available as the root object
                            - HTTP headers are available via .headers (map with lowercase keys)
                            - Example: {{ .pull_request.number }}, {{ .repository.full_name }}
                        type: string
                    required:
                    - description
                    type: object
                  workflowRef:
                    description: |-
                      WorkflowRef references an existing Workflow by name.
                      Creates a WorkflowRun that references this Workflow.
                      Use this to reuse pre-defined Workflow templates.
                      Mutually exclusive with Task and WorkflowRun.
                    type: string
                  workflowRun:
                    description: |-
                      WorkflowRun defines a WorkflowRun to create with inline workflow definition.
                      Use this for multi-stage workflows defined directly in the trigger.
                      Mutually exclusive with Task and WorkflowRef.
                    properties:
                      inline:
                        description: |-
                          Inline defines workflow stages directly in the trigger.
                          Use this for ad-hoc workflows that don't need to be reused.
                          Stage task descriptions support Go template syntax with webhook payload data.
                          Mutually exclusive with WorkflowRef.
                        properties:
                          stages:
                            description: |-
                              Stages defines the sequential stages of the workflow.
                              Each stage contains one or more tasks that run in parallel.
                              Stages are executed sequentially - stage N+1 starts only after
                              all tasks in stage N complete successfully.
                            items:
                              description: WorkflowStage defines a stage in the workflow
                                containing parallel tasks.
                              properties:
                                name:
                                  description: |-
                                    Name is an optional name for this stage.
                                    If not specified, auto-generated as "stage-0", "stage-1", etc.
                                    based on the stage's index in the stages array.
                                  type: string
                                tasks:
                                  description: |-
                                    Tasks defines the tasks to run in parallel within this stage.
                                    All tasks in a stage start simultaneously and must all complete
                                    successfully before the next stage begins.
                                  items:
                                    description: |-
                                      WorkflowTask defines a task within a workflow stage.
                                      Each task will be created as a Task CR when its stage starts.
                                    properties:
                                      name:
                                        description: |-
                                          Name is a required unique name for this task within the workflow.
                                          The actual Task CR name will be "{workflow-name}-{task-name}".
                                          Must be a valid Kubernetes name (lowercase, alphanumeric, hyphens).
                                        maxLength: 53
                                        minLength: 1
                                        pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                                        type: string
                                      spec:
                                        description: |-
                                          Spec is the TaskSpec that will be used to create the Task.
                                          Each task should specify its own agentRef as needed.
                                        properties:
                                          agentRef:
                                            description: |-
                                              AgentRef references an Agent for this task.
                                              If not specified, uses the "default" Agent in the same namespace.
                                            type: string
                                          contexts:
                                            description: |-
                                              Contexts provides additional context for the task.
                                              Contexts are processed in array order, with later contexts taking precedence.

                                              Context priority (lowest to highest):
                                                1. Agent.contexts (Agent-level defaults)
                                                2. Task.contexts (Task-specific contexts)
                                                3. Task.description (highest, becomes ${WORKSPACE_DIR}/task.md)

                                              Example:
                                                contexts:
                                                  - type: Text
                                                    text: "Always use conventional commits"
                                                  - type: Git
                                                    mountPath: src
                                                    git:
                                                      repository: https://github.com/org/repo
                                                      ref: main
                                            items:
                                              description: |-
                                                ContextItem defines context with content and mount path.
                                                Used directly in Task/Agent specs to provide additional context for task execution.
                                              properties:
                                                configMap:
                                                  description: ConfigMap context (required
                                                    when Type == "ConfigMap")
                                                  properties:
                                                    key:
                                                      description: |-
                                                        Key specifies a single key to mount as a file.
                                                        If not specified, all keys are mounted as files in the directory.
                                                      type: string
                                                    name:
                                                      description: Name of the ConfigMap
                                                      type: string
                                                    optional:
                                                      description: Optional specifies
                                                        whether the ConfigMap must
                                                        exist.
                                                      type: boolean
                                                  required:
                                                  - name
                                                  type: object
                                                fileMode:
                                                  description: |-
                                                    FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                                                    Only applicable when MountPath is specified.
                                                    If not specified, defaults to 0644.
                                                  format: int32
                                                  type: integer
                                                git:
                                                  description: Git context (required
                                                    when Type == "Git")
                                                  properties:
                                                    depth:
                                                      default: 1
                                                      description: |-
                                                        Depth specifies the clone depth for shallow cloning.
                                                        1 means shallow clone (fastest), 0 means full clone.
                                                        Defaults to 1 for efficiency.
                                                      type: integer
                                                    path:
                                                      description: |-
                                                        Path is the path within the repository to mount.
                                                        Can be a file or directory. If empty, the entire repository is mounted.

                                                        Note on .git directory:
                                                          - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                                          - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                                        Example: ".claude/", "docs/guide.md"
                                                      type: string
                                                    ref:
                                                      default: HEAD
                                                      description: |-
                                                        Ref is the Git reference (branch, tag, or commit SHA).
                                                        Defaults to "HEAD" if not specified.
                                                      type: string
                                                    repository:
                                                      description: |-
                                                        Repository is the Git repository URL.
                                                        Example: "https://github.com/org/contexts"
                                                      type: string
                                                    secretRef:
                                                      description: |-
                                                        SecretRef references a Secret containing Git credentials.
                                                        The Secret should contain one of:
                                                          - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                                          - "ssh-privatekey": For SSH key-based auth
                                                        If not specified, anonymous clone is attempted.
                                                      properties:
                                                        name:
                                                          description: Name of the
                                                            Secret containing Git
                                                            credentials.
                                                          type: string
                                                      required:
                                                      - name
                                                      type: object
                                                  required:
                                                  - repository
                                                  type: object
                                                mountPath:
                                                  description: |-
                                                    MountPath specifies where this context should be mounted in the agent pod.

                                                    Path resolution follows Tekton conventions:
                                                    - Absolute paths (starting with "/") are used as-is
                                                    - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                                                    See ContextRef.MountPath for detailed examples.

                                                    Note: For Runtime context type, MountPath is ignored - content is always
                                                    appended to task.md.
                                                  type: string
                                                runtime:
                                                  description: |-
                                                    Runtime context (optional when Type == "Runtime")
                                                    Enables KubeTask platform awareness. The controller injects a system prompt
                                                    that explains the runtime environment to the agent.
                                                  type: object
                                                text:
                                                  description: |-
                                                    Text is the text content (required when Type == "Text").
                                                    Contains text content defined directly in YAML.
                                                  type: string
                                                type:
                                                  description: 'Type of context source:
                                                    Text, ConfigMap, Git, or Runtime'
                                                  enum:
                                                  - Text
                                                  - ConfigMap
                                                  - Git
                                                  - Runtime
                                                  type: string
                                              required:
                                              - type
                                              type: object
                                            type: array
                                          description:
                                            description: |-
                                              Description is the task instruction/prompt.
                                              The controller creates ${WORKSPACE_DIR}/task.md with this content
                                              (where WORKSPACE_DIR is configured in Agent.spec.workspaceDir, defaulting to "/workspace").
                                              This is the primary way to tell the agent what to do.

                                              Example:
                                                description: "Update all dependencies and create a PR"
                                            type: string
                                        type: object
                                    required:
                                    - name
                                    - spec
                                    type: object
                                  minItems: 1
                                  type: array
                              required:
                              - tasks
                              type: object
                            minItems: 1
                            type: array
                        required:
                        - stages
                        type: object
                      workflowRef:
                        description: |-
                          WorkflowRef references an existing Workflow by name.
                          The Workflow must exist in the same namespace as the WebhookTrigger.
                          Mutually exclusive with Inline.
                        type: string
                    type: object
                type: object
              rules:
                description: |-
                  Rules defines multiple filter-to-resourceTemplate mappings.
                  Each rule specifies a CEL filter and the resource template to use when the filter matches.
                  Rules are evaluated in array order.

                  When matchPolicy is "First", only the first matching rule triggers.
                  When matchPolicy is "All", all matching rules trigger (creating multiple resources).

                  Rules is mutually exclusive with the legacy Filter and TaskTemplate fields.
                  If Rules is specified, Filter and TaskTemplate must be empty.
                items:
                  description: |-
                    WebhookRule defines a single rule within a WebhookTrigger.
                    Each rule has its own filter and resourceTemplate, allowing different
                    webhook payloads to trigger different resources from the same URL.
                  properties:
                    concurrencyPolicy:
                      allOf:
                      - enum:
                        - Allow
                        - Forbid
                        - Replace
                      - enum:
                        - Allow
                        - Forbid
                        - Replace
                      description: |-
                        ConcurrencyPolicy overrides the trigger-level concurrencyPolicy for this rule.
                        If not specified, the trigger-level concurrencyPolicy is used.

                        This allows fine-grained control: some rules might use "Allow" to create
                        multiple resources, while others use "Replace" to stop existing resources.

                        Note: When matchPolicy is "All" and concurrencyPolicy is "Replace",
                        each rule tracks its own active resources independently.
                      type: string
                    filter:
                      description: |-
                        Filter is a CEL expression that must evaluate to true for this rule to trigger.
                        If not specified, this rule matches all webhooks (after authentication).

                        The webhook payload is available as the variable "body".
                        HTTP headers are available as the variable "headers" (map[string]string, lowercase keys).

                        Examples:
                          # Match GitHub PR opened events
                          filter: 'body.action == "opened" && has(body.pull_request)'

                          # Match specific event types via headers
                          filter: 'headers["x-github-event"] == "push"'
                      type: string
                    name:
                      description: |-
                        Name is a unique identifier for this rule within the trigger.
                        Used for status tracking, logging, debugging, and resource naming.
                        Must be unique within the rules array.
                      maxLength: 63
                      minLength: 1
                      pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                      type: string
                    resourceTemplate:
                      description: ResourceTemplate defines what resource to create
                        when this rule's filter matches.
                      properties:
                        task:
                          description: |-
                            Task defines a Task to create.
                            Use this for simple single-stage task execution.
                            Mutually exclusive with WorkflowRun and WorkflowRef.
                          properties:
                            agentRef:
                              description: |-
                                AgentRef references an Agent for task execution.
                                If not specified, uses the "default" Agent in the same namespace.
                              type: string
                            contexts:
                              description: Contexts provides additional context for
                                the task.
                              items:
                                description: |-
                                  ContextItem defines context with content and mount path.
                                  Used directly in Task/Agent specs to provide additional context for task execution.
                                properties:
                                  configMap:
                                    description: ConfigMap context (required when
                                      Type == "ConfigMap")
                                    properties:
                                      key:
                                        description: |-
                                          Key specifies a single key to mount as a file.
                                          If not specified, all keys are mounted as files in the directory.
                                        type: string
                                      name:
                                        description: Name of the ConfigMap
                                        type: string
                                      optional:
                                        description: Optional specifies whether the
                                          ConfigMap must exist.
                                        type: boolean
                                    required:
                                    - name
                                    type: object
                                  fileMode:
                                    description: |-
                                      FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                                      Only applicable when MountPath is specified.
                                      If not specified, defaults to 0644.
                                    format: int32
                                    type: integer
                                  git:
                                    description: Git context (required when Type ==
                                      "Git")
                                    properties:
                                      depth:
                                        default: 1
                                        description: |-
                                          Depth specifies the clone depth for shallow cloning.
                                          1 means shallow clone (fastest), 0 means full clone.
                                          Defaults to 1 for efficiency.
                                        type: integer
                                      path:
                                        description: |-
                                          Path is the path within the repository to mount.
                                          Can be a file or directory. If empty, the entire repository is mounted.

                                          Note on .git directory:
                                            - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                            - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                          Example: ".claude/", "docs/guide.md"
                                        type: string
                                      ref:
                                        default: HEAD
                                        description: |-
                                          Ref is the Git reference (branch, tag, or commit SHA).
                                          Defaults to "HEAD" if not specified.
                                        type: string
                                      repository:
                                        description: |-
                                          Repository is the Git repository URL.
                                          Example: "https://github.com/org/contexts"
                                        type: string
                                      secretRef:
                                        description: |-
                                          SecretRef references a Secret containing Git credentials.
                                          The Secret should contain one of:
                                            - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                            - "ssh-privatekey": For SSH key-based auth
                                          If not specified, anonymous clone is attempted.
                                        properties:
                                          name:
                                            description: Name of the Secret containing
                                              Git credentials.
                                            type: string
                                        required:
                                        - name
                                        type: object
                                    required:
                                    - repository
                                    type: object
                                  mountPath:
                                    description: |-
                                      MountPath specifies where this context should be mounted in the agent pod.

                                      Path resolution follows Tekton conventions:
                                      - Absolute paths (starting with "/") are used as-is
                                      - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                                      See ContextRef.MountPath for detailed examples.

                                      Note: For Runtime context type, MountPath is ignored - content is always
                                      appended to task.md.
                                    type: string
                                  runtime:
                                    description: |-
                                      Runtime context (optional when Type == "Runtime")
                                      Enables KubeTask platform awareness. The controller injects a system prompt
                                      that explains the runtime environment to the agent.
                                    type: object
                                  text:
                                    description: |-
                                      Text is the text content (required when Type == "Text").
                                      Contains text content defined directly in YAML.
                                    type: string
                                  type:
                                    description: 'Type of context source: Text, ConfigMap,
                                      Git, or Runtime'
                                    enum:
                                    - Text
                                    - ConfigMap
                                    - Git
                                    - Runtime
                                    type: string
                                required:
                                - type
                                type: object
                              type: array
                            description:
                              description: |-
                                Description is the task instruction/prompt.
                                Supports Go template syntax with webhook payload data.

                                Available template data:
                                  - The entire webhook JSON payload is available as the root object
                                  - HTTP headers are available via .headers (map with lowercase keys)
                                  - Example: {{ .pull_request.number }}, {{ .repository.full_name }}
                              type: string
                          required:
                          - description
                          type: object
                        workflowRef:
                          description: |-
                            WorkflowRef references an existing Workflow by name.
                            Creates a WorkflowRun that references this Workflow.
                            Use this to reuse pre-defined Workflow templates.
                            Mutually exclusive with Task and WorkflowRun.
                          type: string
                        workflowRun:
                          description: |-
                            WorkflowRun defines a WorkflowRun to create with inline workflow definition.
                            Use this for multi-stage workflows defined directly in the trigger.
                            Mutually exclusive with Task and WorkflowRef.
                          properties:
                            inline:
                              description: |-
                                Inline defines workflow stages directly in the trigger.
                                Use this for ad-hoc workflows that don't need to be reused.
                                Stage task descriptions support Go template syntax with webhook payload data.
                                Mutually exclusive with WorkflowRef.
                              properties:
                                stages:
                                  description: |-
                                    Stages defines the sequential stages of the workflow.
                                    Each stage contains one or more tasks that run in parallel.
                                    Stages are executed sequentially - stage N+1 starts only after
                                    all tasks in stage N complete successfully.
                                  items:
                                    description: WorkflowStage defines a stage in
                                      the workflow containing parallel tasks.
                                    properties:
                                      name:
                                        description: |-
                                          Name is an optional name for this stage.
                                          If not specified, auto-generated as "stage-0", "stage-1", etc.
                                          based on the stage's index in the stages array.
                                        type: string
                                      tasks:
                                        description: |-
                                          Tasks defines the tasks to run in parallel within this stage.
                                          All tasks in a stage start simultaneously and must all complete
                                          successfully before the next stage begins.
                                        items:
                                          description: |-
                                            WorkflowTask defines a task within a workflow stage.
                                            Each task will be created as a Task CR when its stage starts.
                                          properties:
                                            name:
                                              description: |-
                                                Name is a required unique name for this task within the workflow.
                                                The actual Task CR name will be "{workflow-name}-{task-name}".
                                                Must be a valid Kubernetes name (lowercase, alphanumeric, hyphens).
                                              maxLength: 53
                                              minLength: 1
                                              pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                                              type: string
                                            spec:
                                              description: |-
                                                Spec is the TaskSpec that will be used to create the Task.
                                                Each task should specify its own agentRef as needed.
                                              properties:
                                                agentRef:
                                                  description: |-
                                                    AgentRef references an Agent for this task.
                                                    If not specified, uses the "default" Agent in the same namespace.
                                                  type: string
                                                contexts:
                                                  description: |-
                                                    Contexts provides additional context for the task.
                                                    Contexts are processed in array order, with later contexts taking precedence.

                                                    Context priority (lowest to highest):
                                                      1. Agent.contexts (Agent-level defaults)
                                                      2. Task.contexts (Task-specific contexts)
                                                      3. Task.description (highest, becomes ${WORKSPACE_DIR}/task.md)

                                                    Example:
                                                      contexts:
                                                        - type: Text
                                                          text: "Always use conventional commits"
                                                        - type: Git
                                                          mountPath: src
                                                          git:
                                                            repository: https://github.com/org/repo
                                                            ref: main
                                                  items:
                                                    description: |-
                                                      ContextItem defines context with content and mount path.
                                                      Used directly in Task/Agent specs to provide additional context for task execution.
                                                    properties:
                                                      configMap:
                                                        description: ConfigMap context
                                                          (required when Type == "ConfigMap")
                                                        properties:
                                                          key:
                                                            description: |-
                                                              Key specifies a single key to mount as a file.
                                                              If not specified, all keys are mounted as files in the directory.
                                                            type: string
                                                          name:
                                                            description: Name of the
                                                              ConfigMap
                                                            type: string
                                                          optional:
                                                            description: Optional
                                                              specifies whether the
                                                              ConfigMap must exist.
                                                            type: boolean
                                                        required:
                                                        - name
                                                        type: object
                                                      fileMode:
                                                        description: |-
                                                          FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                                                          Only applicable when MountPath is specified.
                                                          If not specified, defaults to 0644.
                                                        format: int32
                                                        type: integer
                                                      git:
                                                        description: Git context (required
                                                          when Type == "Git")
                                                        properties:
                                                          depth:
                                                            default: 1
                                                            description: |-
                                                              Depth specifies the clone depth for shallow cloning.
                                                              1 means shallow clone (fastest), 0 means full clone.
                                                              Defaults to 1 for efficiency.
                                                            type: integer
                                                          path:
                                                            description: |-
                                                              Path is the path within the repository to mount.
                                                              Can be a file or directory. If empty, the entire repository is mounted.

                                                              Note on .git directory:
                                                                - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                                                - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                                              Example: ".claude/", "docs/guide.md"
                                                            type: string
                                                          ref:
                                                            default: HEAD
                                                            description: |-
                                                              Ref is the Git reference (branch, tag, or commit SHA).
                                                              Defaults to "HEAD" if not specified.
                                                            type: string
                                                          repository:
                                                            description: |-
                                                              Repository is the Git repository URL.
                                                              Example: "https://github.com/org/contexts"
                                                            type: string
                                                          secretRef:
                                                            description: |-
                                                              SecretRef references a Secret containing Git credentials.
                                                              The Secret should contain one of:
                                                                - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                                                - "ssh-privatekey": For SSH key-based auth
                                                              If not specified, anonymous clone is attempted.
                                                            properties:
                                                              name:
                                                                description: Name
                                                                  of the Secret containing
                                                                  Git credentials.
                                                                type: string
                                                            required:
                                                            - name
                                                            type: object
                                                        required:
                                                        - repository
                                                        type: object
                                                      mountPath:
                                                        description: |-
                                                          MountPath specifies where this context should be mounted in the agent pod.

                                                          Path resolution follows Tekton conventions:
                                                          - Absolute paths (starting with "/") are used as-is
                                                          - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                                                          See ContextRef.MountPath for detailed examples.

                                                          Note: For Runtime context type, MountPath is ignored - content is always
                                                          appended to task.md.
                                                        type: string
                                                      runtime:
                                                        description: |-
                                                          Runtime context (optional when Type == "Runtime")
                                                          Enables KubeTask platform awareness. The controller injects a system prompt
                                                          that explains the runtime environment to the agent.
                                                        type: object
                                                      text:
                                                        description: |-
                                                          Text is the text content (required when Type == "Text").
                                                          Contains text content defined directly in YAML.
                                                        type: string
                                                      type:
                                                        description: 'Type of context
                                                          source: Text, ConfigMap,
                                                          Git, or Runtime'
                                                        enum:
                                                        - Text
                                                        - ConfigMap
                                                        - Git
                                                        - Runtime
                                                        type: string
                                                    required:
                                                    - type
                                                    type: object
                                                  type: array
                                                description:
                                                  description: |-
                                                    Description is the task instruction/prompt.
                                                    The controller creates ${WORKSPACE_DIR}/task.md with this content
                                                    (where WORKSPACE_DIR is configured in Agent.spec.workspaceDir, defaulting to "/workspace").
                                                    This is the primary way to tell the agent what to do.

                                                    Example:
                                                      description: "Update all dependencies and create a PR"
                                                  type: string
                                              type: object
                                          required:
                                          - name
                                          - spec
                                          type: object
                                        minItems: 1
                                        type: array
                                    required:
                                    - tasks
                                    type: object
                                  minItems: 1
                                  type: array
                              required:
                              - stages
                              type: object
                            workflowRef:
                              description: |-
                                WorkflowRef references an existing Workflow by name.
                                The Workflow must exist in the same namespace as the WebhookTrigger.
                                Mutually exclusive with Inline.
                              type: string
                          type: object
                      type: object
                  required:
                  - name
                  - resourceTemplate
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - name
                x-kubernetes-list-type: map
              taskTemplate:
                description: |-
                  TaskTemplate defines the Task to create when a webhook matches.
                  DEPRECATED: Use ResourceTemplate instead for new code.
                  This field is kept for backward compatibility with existing triggers.
                  Mutually exclusive with Rules and ResourceTemplate.
                properties:
                  agentRef:
                    description: |-
                      AgentRef references an Agent for task execution.
                      If not specified, uses the "default" Agent in the same namespace.
                    type: string
                  contexts:
                    description: Contexts provides additional context for the task.
                    items:
                      description: |-
                        ContextItem defines context with content and mount path.
                        Used directly in Task/Agent specs to provide additional context for task execution.
                      properties:
                        configMap:
                          description: ConfigMap context (required when Type == "ConfigMap")
                          properties:
                            key:
                              description: |-
                                Key specifies a single key to mount as a file.
                                If not specified, all keys are mounted as files in the directory.
                              type: string
                            name:
                              description: Name of the ConfigMap
                              type: string
                            optional:
                              description: Optional specifies whether the ConfigMap
                                must exist.
                              type: boolean
                          required:
                          - name
                          type: object
                        fileMode:
                          description: |-
                            FileMode is the file permission mode for the mounted file (e.g., 0755 for executable scripts).
                            Only applicable when MountPath is specified.
                            If not specified, defaults to 0644.
                          format: int32
                          type: integer
                        git:
                          description: Git context (required when Type == "Git")
                          properties:
                            depth:
                              default: 1
                              description: |-
                                Depth specifies the clone depth for shallow cloning.
                                1 means shallow clone (fastest), 0 means full clone.
                                Defaults to 1 for efficiency.
                              type: integer
                            path:
                              description: |-
                                Path is the path within the repository to mount.
                                Can be a file or directory. If empty, the entire repository is mounted.

                                Note on .git directory:
                                  - If Path is empty (entire repo): The mounted directory WILL contain .git/
                                  - If Path is specified (subdirectory): The mounted directory will NOT contain .git/

                                Example: ".claude/", "docs/guide.md"
                              type: string
                            ref:
                              default: HEAD
                              description: |-
                                Ref is the Git reference (branch, tag, or commit SHA).
                                Defaults to "HEAD" if not specified.
                              type: string
                            repository:
                              description: |-
                                Repository is the Git repository URL.
                                Example: "https://github.com/org/contexts"
                              type: string
                            secretRef:
                              description: |-
                                SecretRef references a Secret containing Git credentials.
                                The Secret should contain one of:
                                  - "username" + "password": For HTTPS token-based auth (password can be a PAT)
                                  - "ssh-privatekey": For SSH key-based auth
                                If not specified, anonymous clone is attempted.
                              properties:
                                name:
                                  description: Name of the Secret containing Git credentials.
                                  type: string
                              required:
                              - name
                              type: object
                          required:
                          - repository
                          type: object
                        mountPath:
                          description: |-
                            MountPath specifies where this context should be mounted in the agent pod.

                            Path resolution follows Tekton conventions:
                            - Absolute paths (starting with "/") are used as-is
                            - Relative paths (NOT starting with "/") are prefixed with the agent's workspaceDir

                            See ContextRef.MountPath for detailed examples.

                            Note: For Runtime context type, MountPath is ignored - content is always
                            appended to task.md.
                          type: string
                        runtime:
                          description: |-
                            Runtime context (optional when Type == "Runtime")
                            Enables KubeTask platform awareness. The controller injects a system prompt
                            that explains the runtime environment to the agent.
                          type: object
                        text:
                          description: |-
                            Text is the text content (required when Type == "Text").
                            Contains text content defined directly in YAML.
                          type: string
                        type:
                          description: 'Type of context source: Text, ConfigMap, Git,
                            or Runtime'
                          enum:
                          - Text
                          - ConfigMap
                          - Git
                          - Runtime
                          type: string
                      required:
                      - type
                      type: object
                    type: array
                  description:
                    description: |-
                      Description is the task instruction/prompt.
                      Supports Go template syntax with webhook payload data.

                      Available template data:
                        - The entire webhook JSON payload is available as the root object
                        - Example: {{ .pull_request.number }}, {{ .repository.full_name }}

                      Example:
                        description: |
                          Review Pull Request #{{ .pull_request.number }}
                          Repository: {{ .repository.full_name }}
                          Author: {{ .pull_request.user.login }}
                    type: string
                required:
                - description
                type: object
            type: object
          status:
            description: Status represents the current status of the WebhookTrigger
            properties:
              activeResources:
                description: |-
                  ActiveResources lists the names of currently running resources (Task or WorkflowRun)
                  created by this trigger. Used for concurrency policy enforcement.
                  When using Rules, this contains resources from all rules.
                  For per-rule tracking, see RuleStatuses[].ActiveResources.
                items:
                  type: string
                type: array
              activeTasks:
                description: |-
                  ActiveTasks lists the names of currently running Tasks created by this trigger.
                  DEPRECATED: Use ActiveResources instead for new code.
                  Used for concurrency policy enforcement with legacy TaskTemplate.
                items:
                  type: string
                type: array
              conditions:
                description: Conditions represent the latest available observations
                  of the WebhookTrigger's state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              lastTriggeredTime:
                description: LastTriggeredTime is when the webhook was last triggered
                  successfully.
                format: date-time
                type: string
              observedGeneration:
                description: ObservedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              ruleStatuses:
                description: |-
                  RuleStatuses contains per-rule status information.
                  Only populated when Rules is used (not for legacy TaskTemplate triggers).
                items:
                  description: WebhookRuleStatus contains status information for a
                    single rule.
                  properties:
                    activeResources:
                      description: |-
                        ActiveResources lists the names of currently running resources created by this rule.
                        Used for per-rule concurrency policy enforcement.
                      items:
                        type: string
                      type: array
                    lastTriggeredTime:
                      description: LastTriggeredTime is when this rule was last triggered.
                      format: date-time
                      type: string
                    name:
                      description: Name is the rule name (matches WebhookRule.Name).
                      type: string
                    totalTriggered:
                      description: TotalTriggered is the number of times this rule
                        created a resource.
                      format: int64
                      type: integer
                  required:
                  - name
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - name
                x-kubernetes-list-type: map
              totalTriggered:
                description: TotalTriggered is the total number of times this trigger
                  created a resource.
                format: int64
                type: integer
              webhookURL:
                description: |-
                  WebhookURL is the full URL path for this webhook endpoint.
                  Format: /webhooks/<namespace>/<trigger-name>
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
